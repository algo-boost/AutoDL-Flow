# AutoDL Flow - 用户手册

## 📖 目录

1. [快速开始](#快速开始)
2. [功能详解](#功能详解)
3. [任务配置](#任务配置)
4. [任务部署](#任务部署)
5. [常见问题（FAQ）](#常见问题faq)
6. [示例配置](#示例配置)

---

## 快速开始

### 1. 访问系统

在浏览器中打开：`http://your-server:6008`

### 2. 登录

- **管理员账户**：使用 `admin` 账户登录，可以查看所有用户的任务和配置
- **普通用户**：使用分配的用户名和密码登录，只能查看和管理自己的任务

### 3. 主要功能入口

- **任务配置**：配置代码仓库、数据快照、模型等
- **任务队列**：查看和管理正在运行的任务
- **已停止任务**：查看已停止的任务，支持批量删除

---

## 功能详解

### 任务配置

任务配置页面用于生成作业执行脚本，主要包含以下配置项：

#### 1. 代码仓库配置

- **选择仓库**：勾选需要克隆的代码仓库
- **安装选项**：每个仓库可以独立选择是否安装依赖
- **分支配置**：可以为每个仓库指定 Git 分支（默认使用主分支）

#### 2. 数据快照配置

- **添加快照**：点击"添加快照"按钮添加新的快照
- **快照ID**：输入 Magic AI 平台的 快照ID（必需）
- **快照名称**：为快照设置一个名称（可选）
- **启用缓存**：是否在下载后保存到 `/root/autodl-fs` 作为缓存

**缓存说明**：
- 启用缓存：会从缓存读取，也会保存新缓存
- 禁用缓存：仍会从缓存读取（如果存在），但不会保存新缓存

#### 3. 模型配置

- **选择模型**：从已配置的模型列表中选择需要下载的模型
- **启用缓存**：是否保存模型到缓存目录

**模型下载方式**：
- **百度网盘下载**：配置 `remote_path` 字段
- **URL 下载**：配置 `url` 字段（如 GitHub Releases）

#### 4. 数据集生成

- **输出目录**：数据集保存路径（默认：`/root/autodl-tmp`）
- **数据集名称**：生成的数据集文件夹名称（默认：`merged_dataset`）
- **生成方式**：
  - **按目录生成**：合并所有快照的 `train` 和 `valid` 目录
  - **随机划分**：将所有图片随机划分为训练集和验证集（可设置比例）

#### 5. 生成脚本

- 点击"生成执行脚本"按钮预览脚本
- 点击"下载脚本"按钮保存为 `auto_job.sh`
- 脚本会自动执行所有配置的操作

### 任务部署

任务部署页面用于在 AutoDL 平台上创建和管理任务。

#### 1. 创建部署

- **选择实例**：选择要部署的 GPU 实例
- **上传文件**：可以上传脚本文件或配置文件
- **环境变量**：配置任务运行所需的环境变量
- **运行命令**：设置任务启动命令

#### 2. 任务队列

- **运行中任务**：显示当前正在运行的任务
- **任务信息**：包括实例ID、GPU类型、状态、创建时间等
- **操作**：可以查看任务详情、复制 root 密码等

#### 3. 已停止任务

- **查看历史**：查看所有已停止的任务
- **多选删除**：支持选择多个任务进行批量删除
- **权限控制**：
  - 普通用户只能看到自己创建的任务
  - 管理员可以看到所有用户的任务

---

## 任务配置

### 代码仓库配置

在"设置" → "代码仓库"中管理代码仓库配置：

```json
{
  "name": "hq_det",
  "url": "https://github.com/your-org/hq_det.git",
  "branch": "main",
  "install": true
}
```

**字段说明**：
- `name`：仓库名称（显示名称）
- `url`：Git 仓库地址
- `branch`：要克隆的分支（可选，默认为主分支）
- `install`：是否安装依赖（可选，默认为 false）

### 模型配置

在"设置" → "模型"中管理模型配置：

**方式1：百度网盘下载**
```json
{
  "name": "dino",
  "remote_path": "/apps/autodl/model/dino/",
  "local_path": "/root/autodl-tmp/model/dino"
}
```

**方式2：URL 下载**
```json
{
  "name": "rtdetrv2",
  "url": "https://github.com/lyuwenyu/storage/releases/download/v0.1/rtdetrv2_r34vd_120e_coco_ema.pth",
  "local_path": "/root/autodl-tmp/model/rtdetrv2",
  "filename": "rtdetrv2_r34vd_120e_coco_ema.pth"
}
```

### 类别映射组配置

在"设置" → "类别映射组"中管理类别映射：

```json
{
  "name": "coco_80",
  "mappings": {
    "0": "person",
    "1": "bicycle",
    "2": "car"
  }
}
```

---

## 任务部署

### 创建部署步骤

1. **选择实例**
   - 在实例列表中选择要使用的 GPU 实例
   - 查看实例的 GPU 类型、价格、可用性等信息

2. **上传文件**
   - 点击"上传文件"按钮选择本地文件
   - 上传的文件会显示在文件列表中

3. **配置环境变量**
   - 点击"添加环境变量"按钮
   - 输入变量名和值
   - 可以添加多个环境变量

4. **设置运行命令**
   - 在"运行命令"输入框中输入启动命令
   - 可以使用上传的文件，系统会自动生成下载命令
   - 命令会自动用 `&&` 连接成一行执行

5. **提交部署**
   - 点击"创建部署"按钮提交任务
   - 系统会自动生成完整的执行命令并创建任务

### 任务管理

#### 查看运行中任务

- 在"任务队列" → "运行中"中查看所有正在运行的任务
- 可以查看任务详情、复制 root 密码等

#### 管理已停止任务

- 在"任务队列" → "已停止"中查看所有已停止的任务
- 点击"多选"按钮进入多选模式
- 勾选要删除的任务，点击"批量删除"按钮

**权限说明**：
- 普通用户只能看到自己创建的任务
- 管理员可以看到所有用户的任务

---

## 常见问题（FAQ）

### 1. 登录问题

**Q: 忘记密码怎么办？**

A: 请联系管理员重置密码

**Q: 如何创建新用户？**

A: 管理员可以进行账号创建

### 2. 脚本生成问题

**Q: 脚本执行时提示找不到文件？**

A: 
- 检查文件路径是否正确
- 确保所有依赖的目录已创建
- 检查文件权限

**Q: 如何修改生成的脚本？**

A: 可以在下载脚本后手动编辑，或者重新配置并生成新脚本。

### 3. 文件上传和下载问题

**Q: 上传的文件无法下载？**

A: 
- 检查文件是否成功上传（查看文件列表）
- 确保下载链接未过期（链接有效期为1小时）
- 如果链接过期，系统会在提交任务时自动刷新链接

### 4. 任务部署问题

**Q: 创建部署失败？**

A: 检查以下几点：
- 确保已选择 GPU 实例
- 检查运行命令是否正确
- 查看错误日志获取详细信息

**Q: 任务创建后立即停止？**

A: 
- 检查运行命令是否正确
- 检查环境变量是否配置正确
- 查看任务日志了解停止原因

**Q: 如何查看任务日志？**

A: 通过 SSH 连接到实例查看。

### 5. 缓存问题

**Q: 缓存文件占用空间太大？**

A: 
- 可以在配置快照或模型时禁用缓存（不保存新缓存）
- 手动清理 `/root/autodl-fs` 目录中的旧缓存文件

**Q: 如何强制重新下载？**

A: 
- 删除 `/root/autodl-fs` 中对应的缓存目录
- 或者在配置时禁用缓存，然后手动删除目标目录

### 6. 配置问题

**Q: 如何配置新的代码仓库？**

A: 在"设置" → "代码仓库"中点击"添加仓库"，填写仓库信息：
- 仓库名称
- Git 地址
- 分支（可选）
- 是否安装依赖

**Q: 如何配置新的模型？**

A: 在"设置" → "模型"中点击"添加模型"，选择下载方式：
- 百度网盘：配置 `remote_path`
- URL 下载：配置 `url` 和 `filename`

**Q: 配置保存后不生效？**

A: 
- 刷新页面重新加载配置
- 检查配置格式是否正确（JSON 格式）
- 查看浏览器控制台是否有错误信息

### 7. 权限问题

**Q: 为什么看不到其他用户的任务？**

A: 普通用户只能看到自己创建的任务。如果需要查看所有任务，请使用管理员账户登录。

**Q: 如何切换用户？**

A: 点击右上角的"退出"按钮，然后使用其他账户登录。

### 8. 性能问题

**Q: 页面加载很慢？**

A: 
- 检查网络连接
- 清除浏览器缓存
- 如果任务列表很长，考虑删除旧任务

**Q: 脚本生成很慢？**

A: 
- 检查网络连接
- 减少配置的快照和模型数量
- 使用缓存避免重复下载

### 9. 其他问题

**Q: 如何备份配置和数据？**

A: 所有数据存储在 `data/` 目录中，可以直接备份整个目录：
```bash
tar -czf backup.tar.gz data/
```

**Q: 如何迁移到新服务器？**

A: 
1. 备份 `data/` 目录和配置文件
2. 在新服务器上安装依赖：`pip install -r requirements.txt`
3. 恢复 `data/` 目录和配置文件
4. 启动应用：`python app.py`

**Q: 遇到其他问题怎么办？**

A: 
- 查看应用日志：`logs/error.log` 和 `logs/app.log`
- 检查浏览器控制台的错误信息
- 联系管理员获取帮助

---

## 示例配置

### 示例1：基础训练任务

**场景**：使用 hq_det 仓库，下载一个数据快照，生成训练数据集

**配置步骤**：

1. **代码仓库**：
   - ✅ 勾选 `hq_det`
   - ✅ 勾选"安装依赖"

2. **数据快照**：
   - 快照数量：1
   - 快照1：
     - ID: `12345`
     - 名称: `training_data`
     - ✅ 启用缓存

3. **数据集生成**：
   - 输出目录: `/root/autodl-tmp`
   - 数据集名称: `merged_dataset`
   - 生成方式: 按目录生成

4. **生成脚本**：点击"生成执行脚本"并下载

**生成的脚本会执行**：
- 克隆 hq_det 仓库并安装依赖
- 下载快照 `snapshot_12345` 到 `/root/autodl-tmp/training_data`
- 生成数据集到 `/root/autodl-tmp/merged_dataset`

### 示例2：多快照合并训练

**场景**：合并多个数据快照进行训练

**配置步骤**：

1. **代码仓库**：
   - ✅ 勾选 `hq_det`
   - ✅ 勾选"安装依赖"

2. **数据快照**：
   - 快照数量：3
   - 快照1：ID=`snap_001`, 名称=`data1`, ✅ 启用缓存
   - 快照2：ID=`snap_002`, 名称=`data2`, ✅ 启用缓存
   - 快照3：ID=`snap_003`, 名称=`data3`, ✅ 启用缓存

3. **数据集生成**：
   - 输出目录: `/root/autodl-tmp`
   - 数据集名称: `multi_snapshot_dataset`
   - 生成方式: 按目录生成

**生成的脚本会**：
- 下载所有3个快照
- 合并所有快照的 `train` 目录为训练集
- 合并所有快照的 `valid` 目录为验证集

### 示例3：随机划分数据集

**场景**：将所有图片随机划分为训练集和验证集

**配置步骤**：

1. **数据快照**：
   - 快照数量：2
   - 快照1：ID=`snap_001`, 名称=`all_data1`
   - 快照2：ID=`snap_002`, 名称=`all_data2`

2. **数据集生成**：
   - 输出目录: `/root/autodl-tmp`
   - 数据集名称: `random_split_dataset`
   - 生成方式: 随机划分
   - 训练集比例: 0.8（80% 训练，20% 验证）

**生成的脚本会**：
- 下载所有快照
- 收集所有图片
- 随机划分为 80% 训练集和 20% 验证集

### 示例4：带模型下载的训练任务

**场景**：下载预训练模型并开始训练

**配置步骤**：

1. **代码仓库**：
   - ✅ 勾选 `hq_det`
   - ✅ 勾选"安装依赖"

2. **数据快照**：
   - 快照数量：1
   - 快照1：ID=`snap_001`, 名称=`train_data`

3. **模型**：
   - ✅ 勾选 `dino`（从百度网盘下载）
   - ✅ 启用缓存

4. **数据集生成**：
   - 输出目录: `/root/autodl-tmp`
   - 数据集名称: `dataset`
   - 生成方式: 按目录生成

**生成的脚本会**：
- 克隆仓库并安装依赖
- 下载数据快照
- 从百度网盘下载 dino 模型到 `/root/autodl-tmp/model/dino`
- 生成数据集

### 示例5：使用 URL 下载模型

**场景**：从 GitHub Releases 下载模型

**模型配置**（在"设置" → "模型"中配置）：
```json
{
  "name": "rtdetrv2",
  "url": "https://github.com/lyuwenyu/storage/releases/download/v0.1/rtdetrv2_r34vd_120e_coco_ema.pth",
  "local_path": "/root/autodl-tmp/model/rtdetrv2",
  "filename": "rtdetrv2_r34vd_120e_coco_ema.pth"
}
```

**任务配置**：
- ✅ 勾选 `rtdetrv2` 模型
- ✅ 启用缓存

**生成的脚本会**：
- 使用 `wget` 从 URL 下载模型文件
- 保存到指定路径

### 示例6：任务部署配置

**场景**：在 AutoDL 平台上部署训练任务

**部署配置**：

1. **选择实例**：
   - 选择 RTX 3090 实例（或其他可用 GPU）

2. **上传文件**：
   - 上传生成的 `auto_job.sh` 脚本

3. **环境变量**：
   ```
   CUDA_VISIBLE_DEVICES=0
   PYTHONPATH=/root/hq_det:$PYTHONPATH
   ```

4. **运行命令**：
   ```
   bash auto_job.sh && cd /root/hq_det && python train.py --config configs/train.yaml
   ```

**系统会自动生成完整命令**：
```bash
wget -O "auto_job.sh" "http://your-server:6008/api/download/token123" && bash "auto_job.sh" && cd /root/hq_det && python train.py --config configs/train.yaml
```

### 示例7：多仓库配置

**场景**：同时使用多个代码仓库

**配置步骤**：

1. **代码仓库**：
   - ✅ 勾选 `hq_det`，✅ 安装依赖
   - ✅ 勾选 `hq_job`，✅ 安装依赖
   - ✅ 勾选 `Image-Comparison-Tool`，❌ 不安装依赖

**生成的脚本会**：
- 依次克隆所有选中的仓库
- 只安装勾选了"安装依赖"的仓库

### 示例8：指定 Git 分支

**场景**：使用特定分支的代码

**仓库配置**（在"设置" → "代码仓库"中配置）：
```json
{
  "name": "hq_det",
  "url": "https://github.com/your-org/hq_det.git",
  "branch": "dev",
  "install": true
}
```

**生成的脚本会**：
```bash
git clone -b dev https://github.com/your-org/hq_det.git /root/hq_det
```

---

## 最佳实践

### 1. 使用缓存

- 对于经常使用的快照和模型，建议启用缓存
- 首次下载后会自动建立缓存，后续运行会更快

### 2. 合理配置环境变量

- 在任务部署时，配置必要的环境变量
- 使用 `PYTHONPATH` 指定 Python 模块搜索路径
- 使用 `CUDA_VISIBLE_DEVICES` 指定使用的 GPU

### 3. 文件命名规范

- 使用有意义的快照名称，便于识别
- 数据集名称使用描述性名称，如 `coco_train_2024`

### 4. 定期清理

- 定期删除已停止的旧任务
- 清理不再使用的缓存文件
- 备份重要配置

### 5. 错误处理

- 检查生成的脚本，确保命令正确
- 查看任务日志，及时发现问题
- 使用测试配置验证脚本正确性

---

## 技术支持

如有问题或建议，请联系系统管理员或查看项目文档。

**相关文档**：
- [README.md](README.md) - 项目概述和安装说明
- [IMPROVEMENTS.md](IMPROVEMENTS.md) - 改进建议和开发计划
- [PROJECT_STRUCTURE.md](PROJECT_STRUCTURE.md) - 项目结构说明


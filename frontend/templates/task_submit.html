<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡éƒ¨ç½² - AutoDL Flow</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âš¡</text></svg>">
    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #667eea;
            min-height: 100vh;
            padding: 0;
            color: #333;
        }

        .container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #667eea;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .header h1 {
            font-size: 1.5em;
            font-weight: 700;
        }

        .nav-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-nav {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            text-decoration: none;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-nav:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .nav-tabs {
            display: flex;
            gap: 5px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px;
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 10px 16px;
            background: transparent;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-tab.active {
            background: white;
            color: #667eea;
        }

        .content-area {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        /* ç´§å‡‘å¸ƒå±€ï¼šä¸¤åˆ—å¸ƒå±€ */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.95em;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-toggle {
            background: #6c757d;
            color: white;
            font-size: 0.85em;
            padding: 6px 12px;
            white-space: nowrap;
        }

        .token-status {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .token-status.success {
            background: #d4edda;
            color: #155724;
        }

        .token-status.warning {
            background: #fff3cd;
            color: #856404;
        }

        .token-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .deployment-list {
            margin-top: 15px;
            overflow-x: auto;
        }

        .deployment-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .deployment-table thead {
            background: #667eea;
            color: white;
        }

        .deployment-table th {
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.75em;
        }

        .deployment-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.75em;
            color: #495057;
            vertical-align: top;
        }
        
        /* éƒ¨ç½²åˆ—è¡¨è¡¨æ ¼è‡ªé€‚åº”å®½åº¦ */
        #deployments-list {
            width: 100%;
            overflow-x: auto;
        }
        
        #deployments-list .deployment-table {
            width: 100%;
            min-width: 100%;
            table-layout: auto;
        }

        .deployment-table tbody tr:hover {
            background: #f8f9fa;
        }

        .deployment-table tbody tr:last-child td {
            border-bottom: none;
        }

        .deployment-table code {
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 0.7em;
        }

        .deployment-table .btn {
            margin-top: 4px;
            padding: 2px 8px;
            font-size: 0.7em;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 600;
        }

        .status-running {
            background: #d4edda;
            color: #155724;
        }

        .status-stopped {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 600;
        }

        .status-running {
            background: #d4edda;
            color: #155724;
        }

        .status-stopped {
            background: #f8d7da;
            color: #721c24;
        }

        .gpu-stock-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            min-width: 100%;
        }

        .gpu-stock-container {
            overflow-x: auto;
            width: 100%;
            margin-top: 15px;
        }

        .gpu-stock-table th,
        .gpu-stock-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .gpu-stock-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .gpu-stock-table tr:hover {
            background: #f8f9fa;
        }

        .stock-available {
            color: #28a745;
            font-weight: 600;
        }

        .stock-low {
            color: #ffc107;
            font-weight: 600;
        }

        .stock-zero {
            color: #dc3545;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* å¼¹çª— */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .input-group {
            display: flex;
            gap: 5px;
            align-items: stretch;
        }

        .input-group .form-input {
            flex: 1;
        }

        /* ç§»åŠ¨ç«¯å“åº”å¼ */
        @media (max-width: 768px) {
            .container {
                min-height: 100vh;
            }

            .header {
                padding: 10px 15px;
            }

            .header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .header h1 {
                font-size: 1.2em;
            }

            .nav-buttons {
                width: 100%;
                justify-content: flex-start;
            }

            .btn-nav {
                padding: 6px 10px;
                font-size: 0.8em;
            }

            .nav-tabs {
                width: 100%;
                justify-content: flex-start;
            }

            .nav-tab {
                padding: 8px 12px;
                font-size: 0.85em;
            }

            .content-area {
                padding: 15px;
            }

            .section {
                padding: 15px;
            }

            .deployment-list {
                grid-template-columns: 1fr;
            }

            .gpu-stock-table {
                font-size: 0.85em;
            }

            .gpu-stock-table th,
            .gpu-stock-table td {
                padding: 8px;
            }

            .btn {
                width: 100%;
                margin-right: 0;
            }

            .input-group {
                flex-direction: column;
            }
        }

        /* é…ç½®åˆ—è¡¨æ ·å¼ */
        .scripts-list {
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }

        .script-file-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .script-file-item:hover {
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
            border-color: #667eea;
        }

        .script-file-info {
            flex: 1;
        }

        .script-file-name {
            font-weight: 600;
            font-size: 1em;
            color: #333;
            margin-bottom: 5px;
        }

        .script-file-meta {
            font-size: 0.85em;
            color: #666;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .script-file-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-link {
            background: transparent;
            border: none;
            color: #667eea;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
        }

        .btn-link:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .btn-copy-link {
            color: #28a745;
        }

        .btn-copy-link:hover {
            background: rgba(40, 167, 69, 0.1);
        }

        .btn-delete-link {
            color: #dc3545;
        }

        .btn-delete-link:hover {
            background: rgba(220, 53, 69, 0.1);
        }

        .scripts-list-empty {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 0.9em;
        }

        /* å†å²é…ç½®å¼¹çª—æ ·å¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.3em;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .modal-filters select,
        .modal-filters input {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .config-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .config-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .config-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        }

        .config-info {
            flex: 1;
        }

        .config-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .config-meta {
            font-size: 0.85em;
            color: #666;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .config-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .config-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .btn-load {
            background: #667eea;
            color: white;
        }

        .btn-load:hover {
            background: #5568d3;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .btn-move {
            background: #28a745;
            color: white;
        }

        .btn-move:hover {
            background: #218838;
        }

        .modal-pagination {
            padding: 15px 20px;
            border-top: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .pagination-info {
            color: #666;
            font-size: 0.9em;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .pagination-controls button {
            padding: 6px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .pagination-controls button:hover:not(:disabled) {
            background: #f8f9fa;
            border-color: #667eea;
        }

        .pagination-controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .save-group-input {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 10px;
        }

        .save-group-input input {
            flex: 1;
            padding: 6px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .save-group-input button {
            padding: 6px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .save-group-input button:hover {
            background: #218838;
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes toastSlideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1em;
            }

            .nav-tab {
                padding: 6px 10px;
                font-size: 0.8em;
            }

            .section-title {
                font-size: 1em;
            }

            .content-area {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <h1>ä»»åŠ¡éƒ¨ç½²</h1>
                <div class="nav-buttons">
                    <a href="/task_setup" class="btn-nav">ä»»åŠ¡é…ç½®</a>
                    <a href="/task_submit" class="btn-nav">ä»»åŠ¡éƒ¨ç½²</a>
                    <a href="/experiment_manage" class="btn-nav">ä»»åŠ¡ç›‘æ§</a>
                    <a href="/" class="btn-nav">ä¸»èœå•</a>
                    <button class="btn-nav" onclick="logout()">é€€å‡ºç™»å½•</button>
                </div>
            </div>
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="submit" onclick="switchTab('submit', this)">åˆ›å»ºä»»åŠ¡</button>
                <button class="nav-tab" data-tab="records" onclick="switchTab('records', this)">ä»»åŠ¡è®°å½•</button>
                <button class="nav-tab" data-tab="deployments" onclick="switchTab('deployments', this)">è¿è¡Œä¸­ä»»åŠ¡</button>
                <button class="nav-tab" data-tab="resources" onclick="switchTab('resources', this)">GPU èµ„æº</button>
                <button class="nav-tab" data-tab="settings" onclick="switchTab('settings', this)">ç³»ç»Ÿè®¾ç½®</button>
            </div>
        </div>

        <div class="content-area">
            {% if not autodl_available %}
            <div class="section">
                <div class="section-title">è­¦å‘Š</div>
                <p>autodl-api åº“æœªå®‰è£…ã€‚è¯·è¿è¡Œ <code>pip install autodl-api</code> å®‰è£…ã€‚</p>
            </div>
            {% else %}
            <!-- åˆ›å»ºä»»åŠ¡æ ‡ç­¾é¡µ -->
            <div id="tab-submit" class="tab-content active">
                <div class="section">
                    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <span>åˆ›å»ºæ–°éƒ¨ç½²</span>
                        <button class="btn btn-primary" onclick="openConfigModal()" style="width: auto; padding: 6px 12px; font-size: 0.9em;">å†å²é…ç½®</button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">éƒ¨ç½²åç§° *</label>
                            <input type="text" id="deployment_name" class="form-input" placeholder="my-deployment" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">éƒ¨ç½²ç±»å‹ *</label>
                            <select id="deployment_type" class="form-input">
                                <option value="Job" selected>Job</option>
                                <option value="ReplicaSet">ReplicaSet</option>
                                <option value="Container">Container</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">é•œåƒ *</label>
                            <select id="deployment_image" class="form-input">
                                <option value="">è¯·å…ˆè·å–é•œåƒåˆ—è¡¨</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">GPU æ•°é‡ *</label>
                            <input type="number" id="gpu_num" class="form-input" value="1" min="1" placeholder="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ•°æ®ä¸­å¿ƒåˆ—è¡¨</label>
                        <small style="color: #666; font-size: 0.85em; display: block; margin-bottom: 6px;">å¯å¤šé€‰ï¼Œç•™ç©ºåˆ™è‡ªåŠ¨é€‰æ‹©</small>
                        <div id="dc-checkboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; max-height: 150px; overflow-y: auto; padding: 8px; background: white; border: 1px solid #e9ecef; border-radius: 6px;">
                            <!-- æ•°æ®ä¸­å¿ƒå¤é€‰æ¡†å°†åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">GPU ç±»å‹ *</label>
                        <div id="gpu-checkboxes" style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 6px; padding: 8px; background: white; border: 1px solid #e9ecef; border-radius: 6px;">
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" value="RTX-5090" class="gpu-type-checkbox">
                                <span>RTX 5090</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" value="RTX-4090" class="gpu-type-checkbox" checked>
                                <span>RTX 4090</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" value="RTX-4090D" class="gpu-type-checkbox">
                                <span>RTX 4090D</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" value="RTX-4080" class="gpu-type-checkbox">
                                <span>RTX 4080</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" value="RTX-3090" class="gpu-type-checkbox">
                                <span>RTX 3090</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" value="RTX-3080" class="gpu-type-checkbox">
                                <span>RTX 3080</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" value="RTX-3070" class="gpu-type-checkbox">
                                <span>RTX 3070</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" value="V100" class="gpu-type-checkbox">
                                <span>V100</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" value="A100" class="gpu-type-checkbox">
                                <span>A100</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" value="H100" class="gpu-type-checkbox">
                                <span>H100</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" value="L20" class="gpu-type-checkbox">
                                <span>L20</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                <input type="checkbox" value="L40" class="gpu-type-checkbox">
                                <span>L40</span>
                            </label>
                        </div>
                        <small style="color: #666; font-size: 0.85em; margin-top: 6px; display: block;">å¯å¤šé€‰ï¼Œç•™ç©ºåˆ™è‡ªåŠ¨é€‰æ‹©</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">æ„å»ºè„šæœ¬ï¼ˆå¯é€‰ï¼‰</label>
                        <select id="history_script" class="form-input">
                            <option value="">ä¸ä½¿ç”¨æ„å»ºè„šæœ¬</option>
                        </select>
                        <small style="color: #666; font-size: 0.85em; display: block; margin-top: 4px;">é€‰æ‹©è„šæœ¬åï¼Œå°†è‡ªåŠ¨ä¸‹è½½ä¸º build.sh</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ä¸Šä¼ æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</label>
                        <small style="color: #666; font-size: 0.85em; display: block; margin-bottom: 8px;">ä¸Šä¼ çš„æ–‡ä»¶å°†åœ¨ä»»åŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨ä¸‹è½½åˆ° AutoDL æœåŠ¡å™¨</small>
                        <div style="border: 2px dashed #ced4da; border-radius: 8px; padding: 20px; background: #f8f9fa; margin-bottom: 10px;">
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                <input type="file" id="file_upload_input" style="display: none;" onchange="handleFileSelect(event)" multiple>
                                <button type="button" class="btn btn-primary" onclick="document.getElementById('file_upload_input').click()" style="width: auto; padding: 8px 15px; font-size: 0.9em;">
                                    é€‰æ‹©æ–‡ä»¶
                                </button>
                                <button type="button" class="btn btn-primary" onclick="loadUploadedFiles()" style="width: auto; padding: 8px 15px; font-size: 0.9em; background: #17a2b8;">
                                    åˆ·æ–°åˆ—è¡¨
                                </button>
                            </div>
                            <div id="uploaded-files-list" style="margin-top: 15px;">
                                <div style="color: #6c757d; font-size: 0.9em;">æ­£åœ¨åŠ è½½å·²ä¸Šä¼ çš„æ–‡ä»¶...</div>
                            </div>
                        </div>
                        <div id="selected-files-list" style="margin-top: 10px;">
                            <!-- é€‰ä¸­çš„æ–‡ä»¶åˆ—è¡¨å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ç¯å¢ƒå˜é‡ *</label>
                        <div id="env-vars-container" style="margin-bottom: 8px;">
                            <!-- ç¯å¢ƒå˜é‡è¾“å…¥æ¡†å°†åŠ¨æ€æ·»åŠ  -->
                        </div>
                        <button type="button" class="btn btn-primary" onclick="addEnvVar()" style="width: auto; background: #28a745; padding: 8px 15px; font-size: 0.9em;">+ æ·»åŠ ç¯å¢ƒå˜é‡</button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">è¿è¡Œè„šæœ¬ä»£ç  *</label>
                        <div id="code-editor-container" style="position: relative; border: 2px solid #e9ecef; border-radius: 8px; overflow: hidden; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 10px 15px; border-bottom: 2px solid #dee2e6;">
                                <span style="font-size: 0.9em; color: #495057; font-weight: 600;">
                                    ä»£ç ç¼–è¾‘å™¨
                                </span>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <select id="run_script_type" onchange="updateRunScriptEditor()" style="padding: 6px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 0.9em; background: white; color: #495057; cursor: pointer; font-weight: 600; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                        <option value="shell" selected>Shell</option>
                                        <option value="python">Python</option>
                                    </select>
                                    <button type="button" class="btn btn-primary" onclick="toggleFullscreenEditor()" style="padding: 6px 12px; font-size: 0.85em; width: auto;" title="å…¨å±ç¼–è¾‘">â›¶ å…¨å±</button>
                                </div>
                            </div>
                            <div id="monaco-editor" style="height: 300px; min-height: 250px;"></div>
                            <div style="background: #f8f9fa; padding: 8px 15px; border-top: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;">
                                <small style="color: #6c757d; font-size: 0.85em;">ä¿å­˜è·¯å¾„: /root/run.sh æˆ– /root/run.py</small>
                                <button type="button" class="btn btn-primary" onclick="loadDefaultRunScript()" style="padding: 6px 15px; font-size: 0.85em; width: auto;">åŠ è½½é»˜è®¤æ¨¡æ¿</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å…¨å±ç¼–è¾‘å™¨ -->
                    <div id="fullscreen-editor-modal" class="modal-overlay" style="display: none; z-index: 2000;">
                        <div style="width: 100%; height: 100%; display: flex; flex-direction: column; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 2px solid #dee2e6; background: #f8f9fa;">
                                <span style="font-size: 1em; color: #495057; font-weight: 600;">å…¨å±ä»£ç ç¼–è¾‘å™¨</span>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <select id="fullscreen_script_type" onchange="updateFullscreenEditor()" style="padding: 6px 12px; border: 1px solid #ced4da; border-radius: 6px; font-size: 0.9em; background: white; color: #495057; cursor: pointer;">
                                        <option value="shell" selected>Shell</option>
                                        <option value="python">Python</option>
                                    </select>
                                    <button type="button" class="btn btn-primary" onclick="toggleFullscreenEditor()" style="padding: 6px 15px; font-size: 0.9em;">å…³é—­å…¨å±</button>
                                </div>
                            </div>
                            <div id="fullscreen-monaco-editor" style="flex: 1; width: 100%;"></div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="previewCommand()" style="background: #17a2b8;">æ‰§è¡Œé¢„è§ˆ</button>
                        <button class="btn btn-primary" onclick="createDeployment()">åˆ›å»ºéƒ¨ç½²</button>
                        <button class="btn btn-primary" onclick="saveDeploymentConfig()" style="background: #28a745;">ä¿å­˜è®¾ç½®</button>
                    </div>
                    
                    <!-- é¢„è§ˆå‘½ä»¤å¼¹çª— -->
                    <div id="command-preview-modal" class="modal-overlay" style="display: none; z-index: 2000;">
                        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow: auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #dee2e6;">
                                <h2 style="margin: 0; color: #495057; font-size: 1.3em;">ğŸ“‹ æ‰§è¡Œé¢„è§ˆ</h2>
                                <button type="button" onclick="closeCommandPreview()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">å…³é—­</button>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <label style="display: block; font-weight: 600; color: #495057;">æ‰§è¡Œå‘½ä»¤ï¼š</label>
                                    <div id="preview-task-count" style="font-weight: 600; color: #17a2b8; font-size: 1em;"></div>
                                </div>
                                <pre id="command-preview-text" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px; padding: 15px; font-family: 'Courier New', monospace; font-size: 0.9em; color: #212529; white-space: pre-wrap; word-wrap: break-word; max-height: 500px; overflow-y: auto; margin: 0;"></pre>
                            </div>
                            <div style="background: #e7f3ff; border-left: 4px solid #2196F3; padding: 12px; border-radius: 4px; margin-top: 15px;">
                                <div style="font-weight: 600; color: #1976D2; margin-bottom: 6px;">ğŸ’¡ æç¤º</div>
                                    <div style="color: #495057; font-size: 0.9em; line-height: 1.6;">
                                    æ­¤å‘½ä»¤å°†åœ¨ AutoDL å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œã€‚å‘½ä»¤åŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š<br>
                                    1. ä¸‹è½½ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆå¦‚æœå·²é€‰æ‹©ï¼‰<br>
                                    2. ä¸‹è½½æ„å»ºè„šæœ¬ build.shï¼ˆå¦‚æœå·²é€‰æ‹©ï¼‰<br>
                                    3. ä¸‹è½½ç¯å¢ƒå˜é‡è„šæœ¬ env.sh<br>
                                    4. åŠ è½½ç¯å¢ƒå˜é‡<br>
                                    5. ä¸‹è½½è¿è¡Œè„šæœ¬ run.sh/run.py<br>
                                    6. æ‰§è¡Œè¿è¡Œè„šæœ¬<br><br>
                                    <strong>æ‰¹é‡æäº¤è¯´æ˜ï¼š</strong>åŒä¸€ä¸ªç¯å¢ƒå˜é‡åå¯ä»¥æ·»åŠ å¤šè¡Œï¼Œæ¯è¡Œä¸€ä¸ªå€¼ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰ç»„åˆå¹¶æ‰¹é‡æäº¤ã€‚
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä»»åŠ¡è®°å½•æ ‡ç­¾é¡µ -->
            <div id="tab-records" class="tab-content">
                <div class="section">
                    <div class="section-title" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <span>ä»»åŠ¡è®°å½•</span>
                        <button class="btn btn-primary" onclick="loadRecords()" style="width: auto; padding: 6px 12px; font-size: 0.9em;">åˆ·æ–°åˆ—è¡¨</button>
                    </div>
                    <div id="records-list" class="config-list">
                        <div class="scripts-list-empty">æ­£åœ¨åŠ è½½...</div>
                    </div>
                    <div class="modal-pagination" style="justify-content: center; margin-top: 15px; padding: 15px 20px; border-top: 2px solid #e9ecef;">
                        <div class="pagination-info" id="recordsPaginationInfo">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</div>
                        <div class="pagination-controls" style="margin-left: 20px;">
                            <button onclick="changeRecordsPage(-1)" id="recordsPrevPageBtn" style="padding: 6px 12px; border: 1px solid #ced4da; border-radius: 6px; background: white; cursor: pointer; font-size: 0.9em;">ä¸Šä¸€é¡µ</button>
                            <span id="recordsPageInfo" style="margin: 0 10px; font-size: 0.9em;">1 / 1</span>
                            <button onclick="changeRecordsPage(1)" id="recordsNextPageBtn" style="padding: 6px 12px; border: 1px solid #ced4da; border-radius: 6px; background: white; cursor: pointer; font-size: 0.9em;">ä¸‹ä¸€é¡µ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¿è¡Œä¸­ä»»åŠ¡æ ‡ç­¾é¡µ -->
            <div id="tab-deployments" class="tab-content">
                <div class="section">
                    <div class="section-title">
                        <span>è¿è¡Œä¸­ä»»åŠ¡</span>
                        <button class="btn btn-primary" onclick="loadDeployments()" style="margin-left: auto;">åˆ·æ–°åˆ—è¡¨</button>
                    </div>
                    <div id="deployments-list" class="deployment-list">
                        <div class="loading">ç‚¹å‡»"åˆ·æ–°åˆ—è¡¨"åŠ è½½è¿è¡Œä¸­ä»»åŠ¡ä¿¡æ¯</div>
                    </div>
                </div>
            </div>
            

            <!-- GPU èµ„æºæ ‡ç­¾é¡µ -->
            <div id="tab-resources" class="tab-content">
                <div class="section">
                    <div class="section-title">
                        <span>GPU èµ„æº</span>
                        <button class="btn btn-primary" onclick="loadGPUStock()" style="margin-left: auto;">åˆ·æ–°èµ„æº</button>
                    </div>
                    <div id="gpu-stock-content">
                        <div class="loading">ç‚¹å‡»"åˆ·æ–°èµ„æº"åŠ è½½ GPU èµ„æºä¿¡æ¯</div>
                    </div>
                </div>
            </div>

            <!-- ç³»ç»Ÿè®¾ç½®æ ‡ç­¾é¡µ -->
            <div id="tab-settings" class="tab-content">
                <div class="section">
                    <div class="section-title">âš™ï¸ Token é…ç½®</div>
                    <div id="token-status" class="token-status" style="display: none;">
                        <span id="token-status-text"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">AutoDL API Token</label>
                        <div class="input-group">
                            <input type="password" id="api_token" class="form-input" placeholder="è¯·è¾“å…¥ Token">
                            <button type="button" class="btn btn-toggle" onclick="toggleTokenVisibility()" id="toggle-btn">æ˜¾ç¤º</button>
                        </div>
                        <small style="color: #666; font-size: 0.85em; display: block; margin-top: 5px;">Token å°†åŠ å¯†å­˜å‚¨åœ¨æœåŠ¡å™¨ä¸Š</small>
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="saveToken()">ä¿å­˜ Token</button>
                        <button class="btn btn-primary" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
                        <button class="btn btn-danger" onclick="deleteToken()">åˆ é™¤ Token</button>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Token è¾“å…¥å¼¹çª— -->
    <div id="token-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">é…ç½® AutoDL API Token</div>
            <div class="form-group">
                <label class="form-label">è¯·è¾“å…¥æ‚¨çš„ AutoDL API Token</label>
                <input type="password" id="modal_token" class="form-input" placeholder="è¯·è¾“å…¥ Token">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="saveTokenFromModal()">ä¿å­˜å¹¶è¿æ¥</button>
                <button class="btn" onclick="closeTokenModal()" style="background: #6c757d; color: white;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å†å²é…ç½®å¼¹çª— -->
    <div id="configModal" class="modal-overlay" onclick="if(event.target === this) closeConfigModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>å†å²é…ç½®ç®¡ç†</h2>
                <button class="modal-close" onclick="closeConfigModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-filters">
                    <select id="configGroupFilter" onchange="loadConfigs()" style="min-width: 150px;">
                        <option value="">å…¨éƒ¨åˆ†ç»„</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadConfigs()" style="padding: 8px 15px;">åˆ·æ–°</button>
                </div>
                <div class="config-list" id="configList">
                    <div class="scripts-list-empty">æ­£åœ¨åŠ è½½...</div>
                </div>
            </div>
            <div class="modal-pagination" style="justify-content: center;">
                <button class="btn btn-primary" onclick="loadConfigs()" style="padding: 8px 15px;">åˆ·æ–°åˆ—è¡¨</button>
            </div>
        </div>
    </div>

    <!-- ä¿å­˜è®¾ç½®åˆ†ç»„é€‰æ‹©å¼¹çª— -->
    <div id="saveGroupModal" class="modal-overlay" onclick="if(event.target === this) closeSaveGroupModal()">
        <div class="modal-content" style="max-width: 500px;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>ä¿å­˜é…ç½®åˆ°åˆ†ç»„</h2>
                <button class="modal-close" onclick="closeSaveGroupModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©åˆ†ç»„</label>
                    <select id="saveGroupSelect" class="form-input">
                        <option value="">é»˜è®¤ï¼ˆä¸åˆ†ç»„ï¼‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">æˆ–åˆ›å»ºæ–°åˆ†ç»„</label>
                    <input type="text" id="newGroupName" class="form-input" placeholder="è¾“å…¥æ–°åˆ†ç»„åç§°">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-primary" onclick="confirmSaveConfig()" style="flex: 1;">ç¡®è®¤ä¿å­˜</button>
                    <button class="btn btn-primary" onclick="closeSaveGroupModal()" style="background: #6c757d; flex: 1;">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç§»åŠ¨åˆ°åˆ†ç»„å¼¹çª— -->
    <div id="moveGroupModal" class="modal-overlay" onclick="if(event.target === this) closeMoveGroupModal()">
        <div class="modal-content" style="max-width: 500px;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>ç§»åŠ¨åˆ°åˆ†ç»„</h2>
                <button class="modal-close" onclick="closeMoveGroupModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©åˆ†ç»„</label>
                    <select id="moveGroupSelect" class="form-input">
                        <option value="">é»˜è®¤ï¼ˆä¸åˆ†ç»„ï¼‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">æˆ–åˆ›å»ºæ–°åˆ†ç»„</label>
                    <input type="text" id="moveNewGroupName" class="form-input" placeholder="è¾“å…¥æ–°åˆ†ç»„åç§°">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-primary" onclick="confirmMoveConfig()" style="flex: 1;">ç¡®è®¤ç§»åŠ¨</button>
                    <button class="btn btn-primary" onclick="closeMoveGroupModal()" style="background: #6c757d; flex: 1;">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tokenVisible = false;
        let currentTab = 'submit';

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ Token å¹¶è‡ªåŠ¨è¿æ¥
        async function initPage() {
            await checkLoginStatus();
            await checkStoredToken();
            await autoConnect();
            // åŠ è½½å·²ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨
            await loadUploadedFiles();
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            try {
                const response = await fetch('/api/scripts', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                if (response.status === 401) {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Check login error:', error);
            }
        }

        // æ£€æŸ¥ Token çŠ¶æ€
        async function checkStoredToken() {
            try {
                const response = await fetch('/api/user/autodl-token', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                const data = await response.json();
                const statusDiv = document.getElementById('token-status');
                const statusText = document.getElementById('token-status-text');
                
                statusDiv.style.display = 'block';
                if (data.has_token) {
                    statusDiv.className = 'token-status success';
                    statusText.textContent = 'âœ“ Token å·²é…ç½®ï¼ˆå·²åŠ å¯†å­˜å‚¨ï¼‰';
                } else {
                    statusDiv.className = 'token-status warning';
                    statusText.textContent = 'âš  æœªé…ç½® Token';
                }
            } catch (error) {
                console.error('Check token error:', error);
            }
        }

        // è‡ªåŠ¨è¿æ¥
        async function autoConnect() {
            try {
                const response = await fetch('/api/user/autodl-token', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                const data = await response.json();
                
                if (!data.has_token) {
                    // å¦‚æœæ²¡æœ‰ Tokenï¼Œæ˜¾ç¤ºå¼¹çª—
                    showTokenModal();
                } else {
                    // å¦‚æœæœ‰ Tokenï¼Œè‡ªåŠ¨æµ‹è¯•è¿æ¥
                    await testConnection(true);
                }
            } catch (error) {
                console.error('Auto connect error:', error);
            }
        }

        // æ˜¾ç¤º Token å¼¹çª—
        function showTokenModal() {
            document.getElementById('token-modal').classList.add('active');
        }

        // å…³é—­ Token å¼¹çª—
        function closeTokenModal() {
            document.getElementById('token-modal').classList.remove('active');
        }

        // ä»å¼¹çª—ä¿å­˜ Token
        async function saveTokenFromModal() {
            const token = document.getElementById('modal_token').value.trim();
            if (!token) {
                alert('è¯·è¾“å…¥ Token');
                return;
            }
            
            try {
                const response = await fetch('/api/user/autodl-token', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify({ token: token })
                });
                
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('modal_token').value = '';
                    closeTokenModal();
                    await checkStoredToken();
                    await testConnection(true);
                } else {
                    alert('ä¿å­˜å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        }

        // åˆ‡æ¢ Token æ˜¾ç¤º/éšè—
        function toggleTokenVisibility() {
            const tokenInput = document.getElementById('api_token');
            const toggleBtn = document.getElementById('toggle-btn');
            
            if (tokenVisible) {
                tokenInput.type = 'password';
                toggleBtn.textContent = 'æ˜¾ç¤º';
                tokenVisible = false;
            } else {
                tokenInput.type = 'text';
                toggleBtn.textContent = 'éšè—';
                tokenVisible = true;
            }
        }

        // ä¿å­˜ Token
        async function saveToken() {
            const token = document.getElementById('api_token').value.trim();
            if (!token) {
                alert('è¯·è¾“å…¥ Token');
                return;
            }
            
            try {
                const response = await fetch('/api/user/autodl-token', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify({ token: token })
                });
                
                const data = await response.json();
                if (response.ok) {
                    alert('Token å·²ä¿å­˜');
                    document.getElementById('api_token').value = '';
                    if (tokenVisible) {
                        toggleTokenVisibility();
                    }
                    await checkStoredToken();
                    await testConnection(true);
                    // æ ¹æ®å½“å‰æ ‡ç­¾é¡µåˆ·æ–°æ•°æ®
                    if (currentTab === 'deployments') {
                        await loadDeployments();
                    } else if (currentTab === 'resources') {
                        await loadGPUStock();
                    }
                } else {
                    alert('ä¿å­˜å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        }

        // åˆ é™¤ Token
        async function deleteToken() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤å·²ä¿å­˜çš„ Token å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch('/api/user/autodl-token', {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                if (response.ok) {
                    alert('Token å·²åˆ é™¤');
                    await checkStoredToken();
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }

        // æµ‹è¯•è¿æ¥
        async function testConnection(silent = false) {
            try {
                const response = await fetch('/api/autodl/test', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify({})
                });

                const data = await response.json();
                if (response.ok) {
                    if (!silent) {
                        alert('è¿æ¥æˆåŠŸï¼');
                    }
                    // æ›´æ–°çŠ¶æ€
                    const statusDiv = document.getElementById('token-status');
                    const statusText = document.getElementById('token-status-text');
                    statusDiv.className = 'token-status success';
                    statusText.textContent = 'âœ“ Token å·²é…ç½®ä¸”è¿æ¥æ­£å¸¸';
                } else {
                    if (!silent) {
                        alert('è¿æ¥å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                    const statusDiv = document.getElementById('token-status');
                    const statusText = document.getElementById('token-status-text');
                    statusDiv.className = 'token-status error';
                    statusText.textContent = 'âœ— è¿æ¥å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯');
                }
            } catch (error) {
                if (!silent) {
                    alert('è¿æ¥å¤±è´¥ï¼š' + error.message);
                }
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab, button) {
            // æ›´æ–°å¯¼èˆªæ 
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            if (button) {
                button.classList.add('active');
            } else {
                document.querySelector(`.nav-tab[data-tab="${tab}"]`)?.classList.add('active');
            }
            
            // æ›´æ–°å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            currentTab = tab;
            
            // æ ¹æ®æ ‡ç­¾é¡µåŠ è½½æ•°æ®
            if (tab === 'submit') {
                // è¿›å…¥åˆ›å»ºä»»åŠ¡æ ‡ç­¾é¡µæ—¶è‡ªåŠ¨åŠ è½½é•œåƒåˆ—è¡¨å’Œå†å²è„šæœ¬
                loadHistoryScripts();
                loadImages();
            } else if (tab === 'deployments') {
                // è¿›å…¥è¿è¡Œä¸­ä»»åŠ¡æ ‡ç­¾é¡µæ—¶è‡ªåŠ¨åŠ è½½éƒ¨ç½²åˆ—è¡¨
                loadDeployments();
            } else if (tab === 'records') {
                loadRecords();
            } else if (tab === 'deployments') {
                loadDeployments();
            } else if (tab === 'resources') {
                loadGPUStock();
            } else if (tab === 'settings') {
                checkStoredToken();
            }
        }

        // åŠ è½½é•œåƒåˆ—è¡¨
        async function loadImages() {
            try {
                const response = await fetch('/api/autodl/images', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify({})
                });

                // æ£€æŸ¥å“åº”ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    alert('åŠ è½½é•œåƒåˆ—è¡¨å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„å“åº”');
                    return;
                }

                const data = await response.json();
                if (response.ok) {
                    const select = document.getElementById('deployment_image');
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©é•œåƒ</option>';
                    data.images.forEach(img => {
                        const option = document.createElement('option');
                        
                        // è·å–é•œåƒåç§°ï¼ˆä¼˜å…ˆä½¿ç”¨ name å­—æ®µï¼Œè¿™æ˜¯æœ€å¸¸è§çš„å­—æ®µåï¼‰
                        let imageName = null;
                        if (img.name) {
                            imageName = img.name;
                        } else if (img.image_name) {
                            imageName = img.image_name;
                        } else if (img.display_name) {
                            imageName = img.display_name;
                        } else if (img.title) {
                            imageName = img.title;
                        } else if (img.repository) {
                            imageName = img.repository;
                        } else if (typeof img === 'string') {
                            imageName = img;
                        }
                        
                        // ä¼˜å…ˆè·å–UUIDï¼ˆç”¨äºæäº¤åˆ°åç«¯ï¼‰- è¿™æ˜¯APIéœ€è¦çš„
                        const imageUuid = img.uuid || img.image_uuid || img.id || img.image_id || imageName;
                        
                        // è®¾ç½®é€‰é¡¹å€¼ï¼ˆä½¿ç”¨UUIDï¼Œç”¨äºæäº¤ï¼‰
                        option.value = imageUuid;
                        
                        // è®¾ç½®æ˜¾ç¤ºæ–‡æœ¬ï¼ˆä¼˜å…ˆæ˜¾ç¤ºåç§°ï¼Œå¦‚æœæ²¡æœ‰åç§°æ‰æ˜¾ç¤ºUUIDï¼‰
                        if (imageName && imageName !== imageUuid) {
                            // å¦‚æœæœ‰åç§°ä¸”åç§°ä¸UUIDä¸åŒï¼Œæ˜¾ç¤ºåç§°
                            option.textContent = imageName;
                        } else {
                            // å¦‚æœåç§°ä¸å­˜åœ¨æˆ–ä¸UUIDç›¸åŒï¼Œæ˜¾ç¤ºUUID
                            option.textContent = imageUuid || 'æœªçŸ¥é•œåƒ';
                        }
                        
                        select.appendChild(option);
                    });
                    // é™é»˜åŠ è½½ï¼Œä¸æ˜¾ç¤ºæç¤ºï¼ˆè‡ªåŠ¨åŠ è½½æ—¶ï¼‰
                    if (currentTab === 'submit') {
                        // è‡ªåŠ¨åŠ è½½æ—¶ä¸æ˜¾ç¤ºæç¤º
                    } else {
                        alert('é•œåƒåˆ—è¡¨åŠ è½½æˆåŠŸï¼');
                    }
                } else {
                    alert('åŠ è½½é•œåƒåˆ—è¡¨å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('åŠ è½½é•œåƒåˆ—è¡¨å¤±è´¥ï¼š' + error.message);
            }
        }

        // è·å–å•ä¸ªéƒ¨ç½²çš„SSHè¿æ¥ä¿¡æ¯
        async function getSSHInfoForDeployment(deploymentUuid) {
            try {
                const response = await fetch(`/api/autodl/deployment/${deploymentUuid}/ssh`, {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                
                // å¤„ç†202çŠ¶æ€ï¼ˆå®¹å™¨å°šæœªåˆ†é…ï¼‰
                if (response.status === 202) {
                    return {
                        status: 'pending',
                        message: data.info || 'å®¹å™¨å°šæœªåˆ†é…ï¼Œæ­£åœ¨æ’é˜Ÿä¸­'
                    };
                }
                
                if (response.ok) {
                    return {
                        status: 'success',
                        sshInfo: data.ssh_info || {}
                    };
                } else {
                    return {
                        status: 'error',
                        message: data.error || 'æœªçŸ¥é”™è¯¯'
                    };
                }
            } catch (error) {
                return {
                    status: 'error',
                    message: error.message || 'ç½‘ç»œé”™è¯¯'
                };
            }
        }

        // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
        // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            // å¤„ç†è½¬ä¹‰å­—ç¬¦ï¼Œæ¢å¤åŸå§‹æ–‡æœ¬
            const unescapedText = text.replace(/\\'/g, "'").replace(/\\n/g, '\n');
            
            // ä¼˜å…ˆä½¿ç”¨ç°ä»£ Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(unescapedText).then(() => {
                    showMessage('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    // é™çº§åˆ°ä¼ ç»Ÿæ–¹æ³•
                    fallbackCopyToClipboard(unescapedText);
                });
            } else {
                // é™çº§åˆ°ä¼ ç»Ÿæ–¹æ³•
                fallbackCopyToClipboard(unescapedText);
            }
        }
        
        // é™çº§å¤åˆ¶æ–¹æ³•ï¼ˆå…¼å®¹æ—§æµè§ˆå™¨ï¼‰
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showMessage('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
                } else {
                    showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                }
            } catch (err) {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            } finally {
                document.body.removeChild(textArea);
            }
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
        function showMessage(message, type = 'info') {
            // åˆ›å»ºæç¤ºå…ƒç´ 
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 24px;
                background: ${bgColor};
                color: white;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                z-index: 10000;
                font-size: 14px;
                animation: toastSlideIn 0.3s ease-out;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                toast.style.animation = 'toastSlideOut 0.3s ease-out';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        // åœæ­¢éƒ¨ç½²
        async function stopDeployment(deploymentUuid, button) {
            if (!confirm('ç¡®å®šè¦åœæ­¢è¯¥éƒ¨ç½²å—ï¼Ÿ')) {
                return;
            }
            
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'åœæ­¢ä¸­...';
            
            try {
                const response = await fetch(`/api/autodl/deployment/${deploymentUuid}/stop`, {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                if (response.ok && data.success) {
                    showMessage('éƒ¨ç½²å·²åœæ­¢', 'success');
                    // åˆ·æ–°éƒ¨ç½²åˆ—è¡¨
                    await loadDeployments();
                } else {
                    showMessage('åœæ­¢å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                    button.textContent = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                showMessage('åœæ­¢å¤±è´¥: ' + error.message, 'error');
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        // åˆ é™¤éƒ¨ç½²
        async function deleteDeployment(deploymentUuid, button) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥éƒ¨ç½²å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'åˆ é™¤ä¸­...';
            
            try {
                const response = await fetch(`/api/autodl/deployment/${deploymentUuid}/delete`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                if (response.ok && data.success) {
                    showMessage('éƒ¨ç½²å·²åˆ é™¤', 'success');
                    // åˆ·æ–°éƒ¨ç½²åˆ—è¡¨
                    await loadDeployments();
                } else {
                    showMessage('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                    button.textContent = originalText;
                    button.disabled = false;
                }
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        // ç¡®ä¿å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸï¼ˆè¿™äº›å‡½æ•°åœ¨å®šä¹‰æ—¶å°±ä¼šè‡ªåŠ¨æˆä¸ºå…¨å±€å‡½æ•°ï¼‰
        window.copyToClipboard = copyToClipboard;
        window.stopDeployment = stopDeployment;
        window.deleteDeployment = deleteDeployment;

        // åŠ è½½å†å²è„šæœ¬åˆ—è¡¨
        async function loadHistoryScripts() {
            const select = document.getElementById('history_script');
            if (!select) return;
            select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
            
            try {
                const response = await fetch('/api/scripts', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                // æ£€æŸ¥å“åº”ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    select.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„å“åº”</option>';
                    return;
                }
                
                const data = await response.json();
                if (response.ok) {
                    select.innerHTML = '<option value="">ä¸ä½¿ç”¨å†å²è„šæœ¬</option>';
                    
                    // å…¼å®¹ä¸¤ç§è¿”å›æ ¼å¼ï¼šdata.files æˆ– data.scripts
                    const scripts = data.files || data.scripts || [];
                    if (scripts.length > 0) {
                        scripts.forEach(file => {
                            const option = document.createElement('option');
                            option.value = file.filename;
                            // å¤„ç†æ—¶é—´æ ¼å¼ï¼šå¯èƒ½æ˜¯ ISO å­—ç¬¦ä¸²æˆ–æ—¶é—´æˆ³
                            let modifiedTime = 'æœªçŸ¥æ—¶é—´';
                            if (file.modified) {
                                if (typeof file.modified === 'string') {
                                    modifiedTime = new Date(file.modified).toLocaleString('zh-CN');
                                } else {
                                    modifiedTime = new Date(file.modified * 1000).toLocaleString('zh-CN');
                                }
                            }
                            option.textContent = `${file.filename} (${modifiedTime})`;
                            option.dataset.filename = file.filename;
                            select.appendChild(option);
                        });
                    }
                    
                    // ç»‘å®šé€‰æ‹©äº‹ä»¶
                    select.onchange = async function() {
                        await handleScriptSelection(this.value);
                    };
                } else {
                    select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                    alert('åŠ è½½å†å²è„šæœ¬å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                alert('åŠ è½½å†å²è„šæœ¬å¤±è´¥ï¼š' + error.message);
            }
        }

        // å¤„ç†è„šæœ¬é€‰æ‹©ï¼ˆç°åœ¨åªæ˜¯è®°å½•é€‰æ‹©ï¼Œä¸å†ä¿®æ”¹å¯åŠ¨å‘½ä»¤ï¼‰
        async function handleScriptSelection(filename) {
            // å†å²è„šæœ¬é€‰æ‹©åï¼Œä¼šåœ¨åˆ›å»ºéƒ¨ç½²æ—¶ä½¿ç”¨
            // ä¸éœ€è¦åœ¨è¿™é‡Œåšä»»ä½•å¤„ç†ï¼Œå› ä¸ºå¯åŠ¨å‘½ä»¤ç°åœ¨ç”±runè„šæœ¬æ§åˆ¶
            console.log('Selected history script:', filename);
        }

        // åŠ è½½éƒ¨ç½²åˆ—è¡¨
        async function loadDeployments() {
            const listDiv = document.getElementById('deployments-list');
            if (!listDiv) return;
            listDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch('/api/autodl/deployments', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify({})
                });

                // æ£€æŸ¥å“åº”ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    listDiv.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„å“åº”</div>';
                    return;
                }

                const data = await response.json();
                if (response.ok) {
                    if (data.deployments && data.deployments.length > 0) {
                        // è¿‡æ»¤å‡ºæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡
                        const runningDeployments = data.deployments.filter(deploy => {
                            const status = deploy.status || deploy.state || 'unknown';
                            return status === 'running' || status === 'Running';
                        });
                        
                        if (runningDeployments.length === 0) {
                            listDiv.innerHTML = '<div class="loading">æš‚æ— æ­£åœ¨è¿è¡Œçš„éƒ¨ç½²</div>';
                            return;
                        }
                        
                        // åˆ›å»ºè¡¨æ ¼
                        let html = '<table class="deployment-table">';
                        html += '<thead><tr>';
                        html += '<th>éƒ¨ç½²åç§°</th>';
                        html += '<th>ç±»å‹</th>';
                        html += '<th>çŠ¶æ€</th>';
                        html += '<th>åˆ›å»ºæ—¶é—´</th>';
                        html += '<th>SSHå‘½ä»¤</th>';
                        html += '<th>Rootå¯†ç </th>';
                        html += '<th>6006ç«¯å£æœåŠ¡</th>';
                        html += '<th>6008ç«¯å£æœåŠ¡</th>';
                        html += '<th>æ“ä½œ</th>';
                        html += '</tr></thead>';
                        html += '<tbody>';
                        
                        // å¹¶è¡Œè·å–æ‰€æœ‰éƒ¨ç½²çš„SSHä¿¡æ¯
                        const sshInfoPromises = runningDeployments.map(deploy => {
                            const deploymentUuid = deploy.uuid || deploy.id || deploy.deployment_uuid || '';
                            if (deploymentUuid) {
                                return getSSHInfoForDeployment(deploymentUuid).then(sshData => ({
                                    deploy,
                                    sshData
                                }));
                            } else {
                                return Promise.resolve({
                                    deploy,
                                    sshData: { status: 'error', message: 'æ— éƒ¨ç½²UUID' }
                                });
                            }
                        });
                        
                        const deploymentsWithSSH = await Promise.all(sshInfoPromises);
                        
                        deploymentsWithSSH.forEach(({ deploy, sshData }) => {
                            // è·å–éƒ¨ç½²UUID
                            const deploymentUuid = deploy.uuid || deploy.id || deploy.deployment_uuid || '';
                            
                            const status = deploy.status || deploy.state || 'unknown';
                            const statusClass = status === 'running' || status === 'Running' ? 'status-running' : 'status-stopped';
                            const createdTime = deploy.created_at || deploy.created_time || 'æœªçŸ¥';
                            const formattedTime = createdTime !== 'æœªçŸ¥' ? new Date(createdTime).toLocaleString('zh-CN') : 'æœªçŸ¥';
                            
                            const sshInfo = sshData.sshInfo || {};
                            
                            html += '<tr>';
                            html += `<td style="font-weight: 600;">${deploy.name || 'æœªå‘½åéƒ¨ç½²'}</td>`;
                            html += `<td>${deploy.type || deploy.deployment_type || 'æœªçŸ¥'}</td>`;
                            html += `<td><span class="status-badge ${statusClass}">${status}</span></td>`;
                            html += `<td>${formattedTime}</td>`;
                            
                            // SSHå‘½ä»¤åˆ—
                            const sshCommand = sshInfo.ssh_command || sshInfo.command || '';
                            if (sshCommand) {
                                // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢XSS
                                const escapedCommand = sshCommand.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                                html += `<td style="word-break: break-all; padding: 8px;">`;
                                html += `<div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">`;
                                html += `<code style="background: #f8f9fa; padding: 3px 6px; border-radius: 3px; font-size: 0.7em; border: 1px solid #dee2e6; white-space: pre-wrap; flex: 1; min-width: 200px;">${escapedCommand}</code>`;
                                html += `<button class="btn btn-primary" onclick="copyToClipboard('${sshCommand.replace(/'/g, "\\'").replace(/\n/g, '\\n')}')" style="padding: 2px 6px; font-size: 0.65em; white-space: nowrap;">å¤åˆ¶</button>`;
                                html += `</div></td>`;
                            } else if (sshData.status === 'pending') {
                                html += `<td style="color: #856404; font-size: 0.7em; padding: 8px;">${(sshData.message || 'æ’é˜Ÿä¸­').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</td>`;
                            } else if (sshData.status === 'error') {
                                html += `<td style="color: #dc3545; font-size: 0.7em; padding: 8px;">${(sshData.message || 'è·å–å¤±è´¥').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</td>`;
                            } else {
                                html += `<td style="color: #999; padding: 8px;">-</td>`;
                            }
                            
                            // Rootå¯†ç åˆ—
                            if (sshInfo.root_password) {
                                const escapedPassword = sshInfo.root_password.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                                html += `<td style="padding: 8px;">`;
                                html += `<div style="display: flex; align-items: center; gap: 6px;">`;
                                html += `<code style="background: #f8f9fa; padding: 3px 6px; border-radius: 3px; font-size: 0.7em; border: 1px solid #dee2e6; flex: 1; min-width: 100px;">${escapedPassword}</code>`;
                                html += `<button class="btn btn-primary" onclick="copyToClipboard('${sshInfo.root_password.replace(/'/g, "\\'")}')" style="padding: 2px 6px; font-size: 0.65em; white-space: nowrap;">å¤åˆ¶</button>`;
                                html += `</div></td>`;
                            } else {
                                html += `<td style="color: #999; padding: 8px;">-</td>`;
                            }
                            
                            // 6006ç«¯å£æœåŠ¡åˆ—
                            if (sshInfo.service_6006_port_url) {
                                const escapedUrl = sshInfo.service_6006_port_url.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                                html += `<td style="word-break: break-all; padding: 8px;">`;
                                html += `<div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">`;
                                html += `<a href="${sshInfo.service_6006_port_url}" target="_blank" style="color: #007bff; text-decoration: underline; font-size: 0.7em; flex: 1; min-width: 150px; word-break: break-all;">${escapedUrl}</a>`;
                                html += `<button class="btn btn-primary" onclick="copyToClipboard('${sshInfo.service_6006_port_url.replace(/'/g, "\\'")}')" style="padding: 2px 6px; font-size: 0.65em; white-space: nowrap;">å¤åˆ¶</button>`;
                                html += `</div></td>`;
                            } else {
                                html += `<td style="color: #999; padding: 8px;">-</td>`;
                            }
                            
                            // 6008ç«¯å£æœåŠ¡åˆ—
                            if (sshInfo.service_6008_port_url) {
                                const escapedUrl = sshInfo.service_6008_port_url.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
                                html += `<td style="word-break: break-all; padding: 8px;">`;
                                html += `<div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">`;
                                html += `<a href="${sshInfo.service_6008_port_url}" target="_blank" style="color: #007bff; text-decoration: underline; font-size: 0.7em; flex: 1; min-width: 150px; word-break: break-all;">${escapedUrl}</a>`;
                                html += `<button class="btn btn-primary" onclick="copyToClipboard('${sshInfo.service_6008_port_url.replace(/'/g, "\\'")}')" style="padding: 2px 6px; font-size: 0.65em; white-space: nowrap;">å¤åˆ¶</button>`;
                                html += `</div></td>`;
                            } else {
                                html += `<td style="color: #999; padding: 8px;">-</td>`;
                            }
                            
                            // æ“ä½œåˆ—ï¼ˆåœæ­¢å’Œåˆ é™¤ï¼‰
                            html += `<td style="padding: 8px;">`;
                            html += `<div style="display: flex; gap: 6px; align-items: center; flex-wrap: nowrap;">`;
                            if (deploymentUuid) {
                                html += `<button class="btn btn-warning" onclick="stopDeployment('${deploymentUuid.replace(/'/g, "\\'")}', this)" style="padding: 2px 8px; font-size: 0.7em; background: #ffc107; border: none; color: #000; white-space: nowrap; cursor: pointer;">åœæ­¢</button>`;
                                html += `<button class="btn btn-danger" onclick="deleteDeployment('${deploymentUuid.replace(/'/g, "\\'")}', this)" style="padding: 2px 8px; font-size: 0.7em; background: #dc3545; border: none; color: white; white-space: nowrap; cursor: pointer;">åˆ é™¤</button>`;
                            } else {
                                html += `<span style="color: #999; font-size: 0.7em;">æ— UUID</span>`;
                            }
                            html += `</div>`;
                            html += `</td>`;
                            
                            html += '</tr>';
                        });
                        
                        html += '</tbody></table>';
                        listDiv.innerHTML = html;
                    } else {
                        listDiv.innerHTML = '<div class="loading">æš‚æ— éƒ¨ç½²</div>';
                    }
                } else {
                    listDiv.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯') + '</div>';
                }
            } catch (error) {
                listDiv.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥ï¼š' + error.message + '</div>';
            }
        }

        // åŠ è½½ GPU åº“å­˜
        async function loadGPUStock() {
            const contentDiv = document.getElementById('gpu-stock-content');
            if (!contentDiv) return;
            contentDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch('/api/autodl/gpu-stock', {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                // æ£€æŸ¥å“åº”ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    contentDiv.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„å“åº”</div>';
                    return;
                }

                const data = await response.json();
                if (response.ok) {
                    const gpuStock = data.gpu_stock || {};
                    // æ˜¾ç¤ºæ‰€æœ‰GPUå‹å·
                    const gpuTypes = ['RTX-5090', 'RTX-4090', 'RTX-4090D', 'RTX-4080', 'RTX-3090', 'RTX-3080', 'RTX-3070', 'V100', 'A100', 'H100', 'L20', 'L40'];
                    
                    let html = '<table class="gpu-stock-table"><thead><tr><th>æ•°æ®ä¸­å¿ƒ</th>';
                    gpuTypes.forEach(type => {
                        html += `<th>${type}</th>`;
                    });
                    html += '</tr></thead><tbody>';
                    
                    // æŒ‰ç…§æŒ‡å®šçš„é¡ºåºæ˜¾ç¤ºæ•°æ®ä¸­å¿ƒ
                    const datacenterOrder = [
                        "è¥¿åŒ—ä¼ä¸šåŒº(æ¨è)",
                        "è¥¿åŒ—BåŒº",
                        "åŒ—äº¬AåŒº",
                        "åŒ—äº¬BåŒº",
                        "L20ä¸“åŒº(åŸåŒ—äº¬CåŒº)",
                        "V100ä¸“åŒº(åŸåå—AåŒº)",
                        "å†…è’™AåŒº",
                        "ä½›å±±åŒº",
                        "é‡åº†AåŒº",
                        "3090ä¸“åŒº",
                        "å†…è’™BåŒº"
                    ];
                    
                    // å»æ‰æ‹¬å·å†…å®¹çš„è¾…åŠ©å‡½æ•°
                    function cleanDCName(name) {
                        return name.replace(/\([^)]*\)/g, '').trim();
                    }
                    
                    // æŒ‰ç…§é¡ºåºéå†æ•°æ®ä¸­å¿ƒï¼Œç¡®ä¿æ‰€æœ‰æ•°æ®ä¸­å¿ƒéƒ½æ˜¾ç¤º
                    datacenterOrder.forEach(dcNameCn => {
                        const displayName = cleanDCName(dcNameCn);
                        html += `<tr><td><strong>${displayName}</strong></td>`;
                        gpuTypes.forEach(type => {
                            let stockText = 'N/A';
                            let stockClass = 'stock-zero';
                            
                            // æ£€æŸ¥æ˜¯å¦æœ‰è¯¥æ•°æ®ä¸­å¿ƒçš„æ•°æ®
                            if (gpuStock[dcNameCn] && gpuStock[dcNameCn][type]) {
                                const stock = gpuStock[dcNameCn][type];
                                
                                if (stock && !stock.error) {
                                    // è·å–ç©ºé—²æ•°é‡å’Œæ€»æ•°é‡
                                    const idle = stock.idle_gpu_num || stock.available || stock.count || 
                                                stock.quantity || stock.num || stock.stock || 
                                                (typeof stock === 'number' ? stock : 0);
                                    const total = stock.total_gpu_num || stock.total || stock.total_count || idle;
                                    
                                    // æ˜¾ç¤ºæ ¼å¼ï¼šç©ºé—²æ•°é‡/æ€»æ•°é‡
                                    if (total > 0) {
                                        stockText = `${idle}/${total}`;
                                    } else {
                                        stockText = `${idle}`;
                                    }
                                    
                                    // æ ¹æ®ç©ºé—²æ•°é‡è®¾ç½®æ ·å¼
                                    if (idle > 10) {
                                        stockClass = 'stock-available';
                                    } else if (idle > 0) {
                                        stockClass = 'stock-low';
                                    } else {
                                        stockClass = 'stock-zero';
                                    }
                                } else if (stock && stock.error) {
                                    stockText = 'é”™è¯¯';
                                    stockClass = 'stock-zero';
                                } else if (stock && stock.raw) {
                                    stockText = stock.raw;
                                    stockClass = 'stock-zero';
                                }
                            }
                            
                            html += `<td class="${stockClass}">${stockText}</td>`;
                        });
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    contentDiv.innerHTML = '<div class="gpu-stock-container">' + html + '</div>';
                } else {
                    contentDiv.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯') + '</div>';
                }
            } catch (error) {
                contentDiv.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥ï¼š' + error.message + '</div>';
            }
        }

        // å»æ‰æ•°æ®ä¸­å¿ƒåç§°ä¸­çš„æ‹¬å·å†…å®¹
        function cleanDatacenterName(name) {
            return name.replace(/\([^)]*\)/g, '').trim();
        }

        // åˆå§‹åŒ–æ•°æ®ä¸­å¿ƒå¤é€‰æ¡†
        function initDatacenterCheckboxes() {
            const container = document.getElementById('dc-checkboxes');
            const datacenters = [
                "è¥¿åŒ—ä¼ä¸šåŒº(æ¨è)",
                "è¥¿åŒ—BåŒº",
                "åŒ—äº¬AåŒº",
                "åŒ—äº¬BåŒº",
                "L20ä¸“åŒº(åŸåŒ—äº¬CåŒº)",
                "V100ä¸“åŒº(åŸåå—AåŒº)",
                "å†…è’™AåŒº",
                "ä½›å±±åŒº",
                "é‡åº†AåŒº",
                "3090ä¸“åŒº",
                "å†…è’™BåŒº"
            ];
            
            datacenters.forEach(dc => {
                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; gap: 5px; cursor: pointer;';
                const isDefault = dc === 'å†…è’™BåŒº';
                const displayName = cleanDatacenterName(dc);
                label.innerHTML = `
                    <input type="checkbox" value="${dc}" class="dc-checkbox" ${isDefault ? 'checked' : ''}>
                    <span>${displayName}</span>
                `;
                container.appendChild(label);
            });
        }

        // æ·»åŠ ç¯å¢ƒå˜é‡è¾“å…¥æ¡†
        function addEnvVar(key = '', value = '', required = false, readonly = false, indentLevel = 0, insertAfter = null) {
            const container = document.getElementById('env-vars-container');
            const envVarDiv = document.createElement('div');
            envVarDiv.className = 'env-var-item';
            envVarDiv.style.cssText = 'margin-bottom: 10px;';
            envVarDiv.dataset.envKey = key; // ä¿å­˜keyï¼Œç”¨äºåç»­æ›´æ–°
            envVarDiv.dataset.indentLevel = indentLevel; // ä¿å­˜ç¼©è¿›çº§åˆ«
            
            // è®¡ç®—ç¼©è¿›
            const indentPx = indentLevel * 30;
            
            if (readonly) {
                // åªè¯»æ˜¾ç¤ºé¡¹ï¼ˆJOB_NAME å’Œ GPU_NUMï¼‰- ä¸å¯å¤šé€‰å’Œä¿®æ”¹
                envVarDiv.innerHTML = `
                    <div style="display: flex; gap: 10px; align-items: center; margin-left: ${indentPx}px;">
                        <input type="text" class="form-input env-var-key" value="${key}" style="flex: 1; background: #f8f9fa; cursor: not-allowed;" readonly>
                        <input type="text" class="form-input env-var-value" value="${value}" style="flex: 1; background: #f8f9fa; cursor: not-allowed;" readonly>
                        <span style="color: #6c757d; font-size: 0.85em; padding: 0 10px;">è‡ªåŠ¨åŒæ­¥</span>
                    </div>
                `;
            } else {
                // å¯ç¼–è¾‘é¡¹
                const requiredMark = required ? ' <span style="color: #dc3545;">*</span>' : '';
                envVarDiv.innerHTML = `
                    <div style="display: flex; gap: 10px; align-items: center; margin-left: ${indentPx}px;">
                        <input type="text" class="form-input env-var-key" placeholder="å˜é‡å" value="${key}" style="flex: 1;" ${required ? 'required' : ''}>
                        <input type="text" class="form-input env-var-value" placeholder="å˜é‡å€¼" value="${value}" style="flex: 1;" ${required ? 'required' : ''}>
                        <button type="button" class="btn btn-primary" onclick="duplicateEnvVar(this)" style="width: auto; padding: 10px 15px; background: #17a2b8; font-size: 0.9em;" title="å¤åˆ¶æ­¤è¡Œä»¥æ·»åŠ å¤šä¸ªå€¼">+ æ·»åŠ å€¼</button>
                        <button type="button" class="btn btn-danger" onclick="removeEnvVar(this)" style="width: auto; padding: 10px 15px;" ${required ? 'disabled' : ''}>åˆ é™¤</button>
                    </div>
                `;
            }
            
            // å¦‚æœæŒ‡å®šäº†æ’å…¥ä½ç½®ï¼Œæ’å…¥åˆ°è¯¥å…ƒç´ ä¹‹åï¼›å¦åˆ™è¿½åŠ åˆ°å®¹å™¨æœ«å°¾
            if (insertAfter && insertAfter.nextSibling) {
                container.insertBefore(envVarDiv, insertAfter.nextSibling);
            } else if (insertAfter) {
                container.appendChild(envVarDiv);
            } else {
                container.appendChild(envVarDiv);
            }
        }
        
        // æ›´æ–°åªè¯»ç¯å¢ƒå˜é‡çš„å€¼
        function updateReadonlyEnvVar(key, value) {
            const container = document.getElementById('env-vars-container');
            const items = container.querySelectorAll('.env-var-item');
            items.forEach(item => {
                if (item.dataset.envKey === key) {
                    const valueInput = item.querySelector('.env-var-value');
                    if (valueInput && valueInput.readOnly) {
                        valueInput.value = value;
                    }
                }
            });
        }

        // å¤åˆ¶ç¯å¢ƒå˜é‡è¡Œï¼ˆç”¨äºæ·»åŠ å¤šä¸ªå€¼ï¼‰
        function duplicateEnvVar(button) {
            const item = button.closest('.env-var-item');
            const keyInput = item.querySelector('.env-var-key');
            const valueInput = item.querySelector('.env-var-value');
            
            if (keyInput && valueInput) {
                const key = keyInput.value.trim();
                const value = valueInput.value.trim();
                
                // ä¸å…è®¸å¤åˆ¶åªè¯»çš„ç¯å¢ƒå˜é‡ï¼ˆJOB_NAME å’Œ GPU_NUMï¼‰
                if (keyInput.readOnly) {
                    alert('JOB_NAME å’Œ GPU_NUM æ˜¯è‡ªåŠ¨åŒæ­¥çš„ç¯å¢ƒå˜é‡ï¼Œä¸èƒ½å¤åˆ¶');
                    return;
                }
                
                // è·å–å½“å‰è¡Œçš„ç¼©è¿›çº§åˆ«
                const currentIndent = parseInt(item.dataset.indentLevel || '0');
                
                // å¦‚æœå½“å‰è¡Œå·²ç»ç¼©è¿›ï¼ˆindentLevel > 0ï¼‰ï¼Œåˆ™ä¸å†ç¼©è¿›ï¼›å¦åˆ™å¦‚æœå˜é‡åä¸ä¸ºç©ºï¼Œæ–°è¡Œåº”è¯¥ç¼©è¿›
                const newIndent = currentIndent > 0 ? currentIndent : (key ? 1 : 0);
                
                // åˆ›å»ºæ–°çš„ä¸€è¡Œï¼Œä½¿ç”¨ç›¸åŒçš„å˜é‡åï¼Œä½†å€¼ä¸ºç©ºï¼Œæ’å…¥åˆ°å½“å‰è¡Œä¸‹æ–¹
                addEnvVar(key, '', false, false, newIndent, item);
            }
        }
        
        // åˆ é™¤ç¯å¢ƒå˜é‡è¾“å…¥æ¡†
        function removeEnvVar(button) {
            const item = button.parentElement;
            const keyInput = item.querySelector('.env-var-key');
            if (keyInput) {
                const key = keyInput.value.trim();
                // ä¸å…è®¸åˆ é™¤JOB_NAMEå’ŒGPU_NUM
                if (key === 'JOB_NAME' || key === 'GPU_NUM') {
                    alert('JOB_NAME å’Œ GPU_NUM æ˜¯è‡ªåŠ¨åŒæ­¥çš„ç¯å¢ƒå˜é‡ï¼Œä¸èƒ½åˆ é™¤');
                    return;
                }
            }
            item.remove();
        }

        // åˆå§‹åŒ–ç¯å¢ƒå˜é‡ï¼ˆé»˜è®¤å›ºå®šç¯å¢ƒå˜é‡ï¼‰
        function initEnvVars() {
            const container = document.getElementById('env-vars-container');
            container.innerHTML = '';
            
            // æ·»åŠ åªè¯»ç¯å¢ƒå˜é‡ï¼ˆè‡ªåŠ¨åŒæ­¥ï¼‰- ä¸å¯å¤šé€‰å’Œä¿®æ”¹
            const deploymentName = document.getElementById('deployment_name').value.trim() || '';
            const gpuNum = document.getElementById('gpu_num').value.trim() || '1';
            addEnvVar('JOB_NAME', deploymentName, false, true, 0);
            addEnvVar('GPU_NUM', gpuNum, false, true, 0);
            
            // é»˜è®¤æ·»åŠ å›ºå®šçš„ç¯å¢ƒå˜é‡
            addEnvVar('OUTPUT', '/root/autodl-fs', true, false, 0);
            addEnvVar('DATASET_PATH', '/root/autodl-tmp/dataset', false, false, 0);
            addEnvVar('MODEL_PATH', '/root/autodl-tmp/model/rtdetrv2/rtdetrv2_r50vd_m_7x_coco_ema.pth', false, false, 0);
            addEnvVar('NUM_EPOCHES', '100', false, false, 0);
        }

        // æ–‡ä»¶ä¸Šä¼ ç›¸å…³
        let uploadedFiles = [];
        let selectedFiles = []; // å­˜å‚¨é€‰ä¸­çš„æ–‡ä»¶ {filename, download_url, target_path}
        
        // åŠ è½½å·²ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨
        async function loadUploadedFiles() {
            try {
                const response = await fetch('/api/autodl/uploaded-files', {
                    credentials: 'same-origin'
                });
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                uploadedFiles = data.files || [];
                renderUploadedFilesList();
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('uploaded-files-list').innerHTML = 
                    `<div style="color: #dc3545; font-size: 0.9em;">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // æ¸²æŸ“å·²ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨
        function renderUploadedFilesList() {
            const container = document.getElementById('uploaded-files-list');
            
            if (uploadedFiles.length === 0) {
                container.innerHTML = '<div style="color: #6c757d; font-size: 0.9em;">æš‚æ— å·²ä¸Šä¼ çš„æ–‡ä»¶</div>';
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            uploadedFiles.forEach(file => {
                const sizeKB = (file.size / 1024).toFixed(2);
                const isSelected = selectedFiles.some(f => f.filename === file.filename);
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border: 1px solid #dee2e6; border-radius: 6px; ${isSelected ? 'border-color: #28a745; background: #f0f8f0;' : ''}">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; color: #495057; margin-bottom: 4px; word-break: break-all;">${file.filename}</div>
                            <div style="font-size: 0.85em; color: #6c757d;">${sizeKB} KB</div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center; flex-shrink: 0;">
                            <input type="checkbox" ${isSelected ? 'checked' : ''} 
                                   onchange="toggleFileSelection('${file.filename}', '${file.download_url}', this.checked)"
                                   style="cursor: pointer;">
                            <button type="button" onclick="deleteUploadedFile('${file.filename}')" 
                                    style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">
                                åˆ é™¤
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // åˆ‡æ¢æ–‡ä»¶é€‰æ‹©çŠ¶æ€
        function toggleFileSelection(filename, downloadUrl, isSelected) {
            if (isSelected) {
                // æ·»åŠ æ–‡ä»¶åˆ°é€‰ä¸­åˆ—è¡¨
                const file = uploadedFiles.find(f => f.filename === filename);
                if (file) {
                    selectedFiles.push({
                        filename: filename,
                        download_url: downloadUrl,
                        target_path: `/root/${filename}` // é»˜è®¤è·¯å¾„
                    });
                }
            } else {
                // ä»é€‰ä¸­åˆ—è¡¨ç§»é™¤
                selectedFiles = selectedFiles.filter(f => f.filename !== filename);
            }
            renderSelectedFilesList();
            renderUploadedFilesList();
        }
        
        // æ¸²æŸ“é€‰ä¸­çš„æ–‡ä»¶åˆ—è¡¨
        function renderSelectedFilesList() {
            const container = document.getElementById('selected-files-list');
            
            if (selectedFiles.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<div style="border: 1px solid #28a745; border-radius: 6px; padding: 10px; background: #f0f8f0;">';
            html += '<div style="font-weight: 600; color: #28a745; margin-bottom: 8px;">å·²é€‰ä¸­çš„æ–‡ä»¶ï¼ˆå°†åœ¨ä»»åŠ¡å¯åŠ¨æ—¶ä¸‹è½½ï¼‰:</div>';
            html += '<div style="display: flex; flex-direction: column; gap: 6px;">';
            
            selectedFiles.forEach((file, index) => {
                html += `
                    <div style="display: flex; gap: 8px; align-items: center; padding: 6px; background: white; border-radius: 4px;">
                        <span style="flex: 1; font-size: 0.9em; color: #495057;">${file.filename}</span>
                        <input type="text" value="${file.target_path}" 
                               placeholder="ç›®æ ‡è·¯å¾„" 
                               onchange="updateFileTargetPath(${index}, this.value)"
                               style="flex: 1; padding: 4px 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.85em;">
                        <button type="button" onclick="removeSelectedFile(${index})" 
                                style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">
                            ç§»é™¤
                        </button>
                    </div>
                `;
            });
            
            html += '</div></div>';
            container.innerHTML = html;
        }
        
        // æ›´æ–°æ–‡ä»¶ç›®æ ‡è·¯å¾„
        function updateFileTargetPath(index, path) {
            if (selectedFiles[index]) {
                selectedFiles[index].target_path = path || `/root/${selectedFiles[index].filename}`;
            }
        }
        
        // ç§»é™¤é€‰ä¸­çš„æ–‡ä»¶
        function removeSelectedFile(index) {
            selectedFiles.splice(index, 1);
            renderSelectedFilesList();
            renderUploadedFilesList();
        }
        
        // è·å–é€‰ä¸­çš„æ–‡ä»¶åˆ—è¡¨
        function getSelectedFiles() {
            return selectedFiles;
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        async function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            
            for (const file of files) {
                await uploadFile(file);
            }
            
            // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
            event.target.value = '';
        }
        
        // ä¸Šä¼ æ–‡ä»¶
        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/autodl/upload-file', {
                    method: 'POST',
                    credentials: 'same-origin',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // ä¸Šä¼ æˆåŠŸåï¼Œè‡ªåŠ¨é€‰ä¸­è¯¥æ–‡ä»¶
                selectedFiles.push({
                    filename: data.filename,
                    download_url: data.download_url,
                    target_path: data.target_path || `/root/${data.filename}`
                });
                
                // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
                await loadUploadedFiles();
                renderSelectedFilesList();
                
                alert(`æ–‡ä»¶ "${data.original_filename}" ä¸Šä¼ æˆåŠŸï¼`);
            } catch (error) {
                console.error('ä¸Šä¼ æ–‡ä»¶å¤±è´¥:', error);
                alert('ä¸Šä¼ æ–‡ä»¶å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ é™¤ä¸Šä¼ çš„æ–‡ä»¶
        async function deleteUploadedFile(filename) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${filename}" å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/autodl/uploaded-files/${encodeURIComponent(filename)}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // ä»é€‰ä¸­åˆ—è¡¨ç§»é™¤
                selectedFiles = selectedFiles.filter(f => f.filename !== filename);
                
                // é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨
                await loadUploadedFiles();
                renderSelectedFilesList();
            } catch (error) {
                console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
                alert('åˆ é™¤æ–‡ä»¶å¤±è´¥: ' + error.message);
            }
        }
        
        // Monaco Editor å®ä¾‹
        let monacoEditor = null;
        let fullscreenMonacoEditor = null;
        let isFullscreen = false;

        // åˆå§‹åŒ–Monaco Editor
        async function initMonacoEditor() {
            if (typeof monaco === 'undefined') {
                console.error('Monaco EditoræœªåŠ è½½');
                return;
            }

            const scriptType = document.getElementById('run_script_type').value;
            const language = scriptType === 'python' ? 'python' : 'shell';
            
            // åˆ›å»ºä¸»ç¼–è¾‘å™¨
            monacoEditor = monaco.editor.create(document.getElementById('monaco-editor'), {
                value: '',
                language: language,
                theme: 'vs-dark',
                fontSize: 14,
                minimap: { enabled: true },
                automaticLayout: true,
                wordWrap: 'on',
                scrollBeyondLastLine: false,
                suggestOnTriggerCharacters: true,
                quickSuggestions: true,
                tabSize: 4,
                insertSpaces: true
            });

            // ç›‘å¬å†…å®¹å˜åŒ–
            monacoEditor.onDidChangeModelContent(() => {
                // å†…å®¹å˜åŒ–æ—¶çš„å¤„ç†
            });

            // åŠ è½½é»˜è®¤æ¨¡æ¿
            await loadDefaultRunScript();
        }

        // æ›´æ–°è¿è¡Œè„šæœ¬ç¼–è¾‘å™¨
        async function updateRunScriptEditor() {
            if (!monacoEditor) return;
            
            const scriptType = document.getElementById('run_script_type').value;
            const language = scriptType === 'python' ? 'python' : 'shell';
            
            // æ›´æ–°è¯­è¨€
            monaco.editor.setModelLanguage(monacoEditor.getModel(), language);
            
            // å¦‚æœå½“å‰å†…å®¹æ˜¯ç©ºçš„ï¼Œé‡æ–°åŠ è½½å¯¹åº”ç±»å‹çš„æ¨¡æ¿
            const currentValue = monacoEditor.getValue().trim();
            if (!currentValue) {
                await loadDefaultRunScript();
            }
        }

        // æ›´æ–°å…¨å±ç¼–è¾‘å™¨
        async function updateFullscreenEditor() {
            if (!fullscreenMonacoEditor) return;
            
            const scriptType = document.getElementById('fullscreen_script_type').value;
            const language = scriptType === 'python' ? 'python' : 'shell';
            
            monaco.editor.setModelLanguage(fullscreenMonacoEditor.getModel(), language);
        }

        // åˆ‡æ¢å…¨å±ç¼–è¾‘
        function toggleFullscreenEditor() {
            const modal = document.getElementById('fullscreen-editor-modal');
            
            if (!isFullscreen) {
                // è¿›å…¥å…¨å±
                modal.style.display = 'flex';
                isFullscreen = true;
                
                // åˆ›å»ºå…¨å±ç¼–è¾‘å™¨
                setTimeout(() => {
                    if (!fullscreenMonacoEditor) {
                        const scriptType = document.getElementById('run_script_type').value;
                        const language = scriptType === 'python' ? 'python' : 'shell';
                        const content = monacoEditor ? monacoEditor.getValue() : '';
                        
                        fullscreenMonacoEditor = monaco.editor.create(document.getElementById('fullscreen-monaco-editor'), {
                            value: content,
                            language: language,
                            theme: 'vs-dark',
                            fontSize: 16,
                            minimap: { enabled: true },
                            automaticLayout: true,
                            wordWrap: 'on',
                            scrollBeyondLastLine: false,
                            suggestOnTriggerCharacters: true,
                            quickSuggestions: true,
                            tabSize: 4,
                            insertSpaces: true
                        });
                        
                        // åŒæ­¥è¯­è¨€é€‰æ‹©å™¨
                        document.getElementById('fullscreen_script_type').value = scriptType;
                    } else {
                        // åŒæ­¥å†…å®¹
                        fullscreenMonacoEditor.setValue(monacoEditor.getValue());
                    }
                }, 100);
            } else {
                // é€€å‡ºå…¨å±ï¼ŒåŒæ­¥å†…å®¹å›ä¸»ç¼–è¾‘å™¨
                if (fullscreenMonacoEditor && monacoEditor) {
                    monacoEditor.setValue(fullscreenMonacoEditor.getValue());
                }
                modal.style.display = 'none';
                isFullscreen = false;
            }
        }

        // åŠ è½½é»˜è®¤è¿è¡Œè„šæœ¬æ¨¡æ¿ï¼ˆä»æœåŠ¡å™¨è·å–ï¼‰
        async function loadDefaultRunScript() {
            const scriptType = document.getElementById('run_script_type').value;
            
            try {
                const response = await fetch('/api/autodl/run-script-templates', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                let template = '';
                
                if (response.ok && data.templates) {
                    if (scriptType === 'python') {
                        template = data.templates.run_py_template || '';
                    } else {
                        template = data.templates.run_sh_template || '';
                    }
                } else {
                    // å¦‚æœè·å–å¤±è´¥ï¼Œä½¿ç”¨å†…ç½®çš„é»˜è®¤å€¼
                    console.error('Failed to load templates:', data.error);
                    template = loadDefaultRunScriptFallback();
                }
                
                // æ›´æ–°Monacoç¼–è¾‘å™¨
                if (monacoEditor) {
                    monacoEditor.setValue(template);
                }
            } catch (error) {
                console.error('Error loading templates:', error);
                // å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œä½¿ç”¨å†…ç½®çš„é»˜è®¤å€¼
                const template = loadDefaultRunScriptFallback();
                if (monacoEditor) {
                    monacoEditor.setValue(template);
                }
            }
        }

        // åå¤‡é»˜è®¤è„šæœ¬ï¼ˆå¦‚æœæ— æ³•ä»æœåŠ¡å™¨åŠ è½½ï¼‰
        function loadDefaultRunScriptFallback() {
            const scriptType = document.getElementById('run_script_type').value;
            
            if (scriptType === 'python') {
                return `#!/usr/bin/env python3
import subprocess
import os
import sys
from pathlib import Path

# åˆ‡æ¢åˆ° /root ç›®å½•
os.chdir('/root')

# è·å– OUTPUT ç¯å¢ƒå˜é‡
output_dir = os.environ.get('OUTPUT', '/root/output')
log_file = os.path.join(output_dir, 'build.log')

# ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
Path(output_dir).mkdir(parents=True, exist_ok=True)

# æ‰§è¡Œ build.shï¼Œå°†è¾“å‡ºé‡å®šå‘åˆ°æ—¥å¿—æ–‡ä»¶
print(f'Starting build.sh, logs will be saved to {log_file}...')
try:
    with open(log_file, 'w', encoding='utf-8') as log:
        log.write(f'=== Starting build.sh ===\\n')
        log.flush()
        
        result = subprocess.run(
            ['bash', 'build.sh'],
            cwd='/root',
            stdout=log,
            stderr=subprocess.STDOUT,
            check=True
        )
        
        log.write(f'\\n=== build.sh completed successfully ===\\n')
        log.flush()
    
    print(f'build.sh completed successfully, logs saved to {log_file}')
    sys.exit(0)
except subprocess.CalledProcessError as e:
    error_msg = f'build.sh failed with error code {e.returncode}'
    print(error_msg)
    with open(log_file, 'a', encoding='utf-8') as log:
        log.write(f'\\n=== ERROR: {error_msg} ===\\n')
    sys.exit(1)
except Exception as e:
    error_msg = f'Error running build.sh: {e}'
    print(error_msg)
    with open(log_file, 'a', encoding='utf-8') as log:
        log.write(f'\\n=== ERROR: {error_msg} ===\\n')
    sys.exit(1)
`;
            } else {
                return `#!/bin/bash
cd /root

nohup bash build.sh > $OUTPUT/build.log 2>&1
`;
            }
        }

        // ç”Ÿæˆç¯å¢ƒå˜é‡ç»„åˆ
        function generateEnvVarCombinations() {
            const envVarMap = {};
            
            // æ”¶é›†æ‰€æœ‰ç¯å¢ƒå˜é‡åŠå…¶å¯èƒ½çš„å€¼
            // åŒä¸€ä¸ªå˜é‡åçš„å¤šä¸ªå€¼ä¼šè¢«åˆå¹¶åˆ°ä¸€ä¸ªæ•°ç»„ä¸­
            document.querySelectorAll('.env-var-item').forEach(item => {
                const keyInput = item.querySelector('.env-var-key');
                const valueInput = item.querySelector('.env-var-value');
                if (keyInput && valueInput) {
                    const key = keyInput.value.trim();
                    const value = valueInput.value.trim();
                    // è·³è¿‡åªè¯»çš„ç¯å¢ƒå˜é‡ï¼ˆJOB_NAME å’Œ GPU_NUMï¼‰
                    if (key && !keyInput.readOnly && value) {
                        // å¦‚æœè¯¥å˜é‡åå·²å­˜åœ¨ï¼Œå°†å€¼æ·»åŠ åˆ°æ•°ç»„ä¸­
                        if (envVarMap[key]) {
                            envVarMap[key].push(value);
                        } else {
                            envVarMap[key] = [value];
                        }
                    }
                }
            });
            
            // æ·»åŠ è‡ªåŠ¨åŒæ­¥çš„ç¯å¢ƒå˜é‡ï¼ˆå›ºå®šå€¼ï¼‰
            const deploymentName = document.getElementById('deployment_name').value.trim() || '';
            const gpuNumStr = document.getElementById('gpu_num').value.trim() || '1';
            envVarMap['JOB_NAME'] = [deploymentName];
            envVarMap['GPU_NUM'] = [gpuNumStr];
            
            // ç”Ÿæˆæ‰€æœ‰ç»„åˆ
            const keys = Object.keys(envVarMap);
            if (keys.length === 0) {
                return {
                    combinations: [{}],
                    totalCount: 1,
                    envVarMap: {}
                };
            }
            
            // è®¡ç®—æ€»ç»„åˆæ•°
            let totalCombinations = 1;
            keys.forEach(key => {
                totalCombinations *= envVarMap[key].length;
            });
            
            // ç”Ÿæˆç»„åˆ
            const combinations = [];
            for (let i = 0; i < totalCombinations; i++) {
                const combination = {};
                let temp = i;
                keys.forEach(key => {
                    const values = envVarMap[key];
                    const index = temp % values.length;
                    combination[key] = values[index];
                    temp = Math.floor(temp / values.length);
                });
                combinations.push(combination);
            }
            
            return {
                combinations: combinations,
                totalCount: totalCombinations,
                envVarMap: envVarMap
            };
        }
        
        // é¢„è§ˆæ‰§è¡Œå‘½ä»¤
        async function previewCommand() {
            try {
                // è·å–è¿è¡Œè„šæœ¬
                const runScriptType = document.getElementById('run_script_type').value;
                const runScriptContent = monacoEditor ? monacoEditor.getValue().trim() : '';
                
                // è·å–å†å²è„šæœ¬ï¼ˆbuild.shï¼‰
                const historyScript = document.getElementById('history_script').value;
                
                // éªŒè¯å¿…å¡«é¡¹
                if (!runScriptContent) {
                    alert('è¯·å…ˆè¾“å…¥è¿è¡Œè„šæœ¬ä»£ç ');
                    return;
                }
                
                // ç”Ÿæˆç¯å¢ƒå˜é‡ç»„åˆ
                const envCombinations = generateEnvVarCombinations();
                const totalTasks = envCombinations.totalCount;
                const envVarMap = envCombinations.envVarMap; // è·å–ç¯å¢ƒå˜é‡æ˜ å°„ï¼Œç”¨äºåˆ¤æ–­å“ªäº›å˜é‡æœ‰å¤šä¸ªå€¼
                
                // è·å–åŸºç¡€åç§°
                const baseName = document.getElementById('deployment_name').value.trim() || '';
                
                // ç¬¬äºŒæ­¥ï¼šä¿å­˜runè„šæœ¬å¹¶è·å–ä¸‹è½½URL
                const runScriptResponse = await fetch('/api/autodl/save-run-script', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        script_content: runScriptContent,
                        script_type: runScriptType
                    })
                });
                
                const runScriptData = await runScriptResponse.json();
                if (!runScriptResponse.ok) {
                    alert('ç”Ÿæˆé¢„è§ˆå¤±è´¥ï¼š' + (runScriptData.error || 'æœªçŸ¥é”™è¯¯'));
                    return;
                }
                
                const runScriptUrl = runScriptData.download_url;
                const runScriptFilename = runScriptData.filename; // run.sh æˆ– run.py
                
                // ç¬¬ä¸‰æ­¥ï¼šå¦‚æœæœ‰å†å²è„šæœ¬ï¼Œè·å–å…¶ä¸‹è½½URL
                let buildScriptUrl = null;
                if (historyScript) {
                    const buildScriptResponse = await fetch(`/api/scripts/${encodeURIComponent(historyScript)}/download`, {
                        method: 'GET',
                        credentials: 'same-origin'
                    });
                    const buildScriptData = await buildScriptResponse.json();
                    if (buildScriptResponse.ok && buildScriptData.download_url) {
                        buildScriptUrl = buildScriptData.download_url;
                    }
                }
                
                // ç¬¬å››æ­¥ï¼šè·å–é€‰ä¸­çš„ä¸Šä¼ æ–‡ä»¶
                const selectedFiles = getSelectedFiles();
                
                // è·å–å®Œæ•´çš„åŸºç¡€URLï¼ˆç”¨äºæ„å»ºå®Œæ•´çš„ä¸‹è½½URLï¼‰
                const baseUrl = window.location.origin;
                
                // ç”Ÿæˆæ‰€æœ‰ä»»åŠ¡çš„é¢„è§ˆ
                let allTasksPreview = [];
                
                // ä¸ºæ¯ä¸ªä»»åŠ¡ç”Ÿæˆé¢„è§ˆ
                for (let i = 0; i < totalTasks; i++) {
                    const taskEnvVars = envCombinations.combinations[i];
                    
                    // ç”Ÿæˆä»»åŠ¡åç§°ï¼ˆå¦‚æœæ˜¯æ‰¹é‡æäº¤ï¼Œæ·»åŠ åç¼€ï¼‰
                    let taskName = baseName;
                    if (totalTasks > 1) {
                        // æ ¹æ®ç¯å¢ƒå˜é‡å€¼ç”Ÿæˆåç¼€ï¼ˆåªåŒ…å«æœ‰å¤šä¸ªå€¼çš„ç¯å¢ƒå˜é‡ï¼‰
                        const suffixParts = [];
                        Object.keys(taskEnvVars).forEach(key => {
                            if (key !== 'JOB_NAME' && key !== 'GPU_NUM' && key !== 'OUTPUT') {
                                // åªå¤„ç†æœ‰å¤šä¸ªå€¼çš„ç¯å¢ƒå˜é‡
                                if (envVarMap[key] && envVarMap[key].length > 1) {
                                    const value = taskEnvVars[key];
                                    // ç®€åŒ–å€¼ä½œä¸ºåç¼€ï¼ˆ/ æ›¿æ¢ä¸º .ï¼Œå…¶ä»–ç‰¹æ®Šå­—ç¬¦æ›¿æ¢ä¸º _ï¼‰
                                    const cleanValue = value.toString().replace(/\//g, '.').replace(/[^a-zA-Z0-9.]/g, '_');
                                    suffixParts.push(`${key}_${cleanValue}`);
                                }
                            }
                        });
                        if (suffixParts.length > 0) {
                            taskName = `${baseName}_${suffixParts.join('_')}`;
                        } else {
                            taskName = `${baseName}_${i + 1}`;
                        }
                    }
                    
                    // ä¸ºå½“å‰ä»»åŠ¡ä¿å­˜ç¯å¢ƒå˜é‡è„šæœ¬å¹¶è·å–URL
                    const taskEnvScriptResponse = await fetch('/api/autodl/save-env-script', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        credentials: 'same-origin',
                        body: JSON.stringify({
                            env_vars: taskEnvVars
                        })
                    });
                    
                    const taskEnvScriptData = await taskEnvScriptResponse.json();
                    if (!taskEnvScriptResponse.ok) {
                        continue; // è·³è¿‡å¤±è´¥çš„ä»»åŠ¡
                    }
                    
                    const taskEnvScriptUrl = taskEnvScriptData.download_url;
                    
                    // æ„å»ºå½“å‰ä»»åŠ¡çš„å¯åŠ¨å‘½ä»¤ï¼ˆæ ¼å¼åŒ–æ˜¾ç¤ºï¼‰
                    let cmdParts = [];
                    
                    // æ·»åŠ ä»»åŠ¡åç§°æ ‡é¢˜
                    if (totalTasks > 1) {
                        cmdParts.push(`# ===== ä»»åŠ¡ ${i + 1}/${totalTasks}: ${taskName} =====`);
                        cmdParts.push('');
                    }
                    
                    // å…ˆä¸‹è½½æ‰€æœ‰é€‰ä¸­çš„æ–‡ä»¶
                    if (selectedFiles.length > 0) {
                        cmdParts.push('# ä¸‹è½½ä¸Šä¼ çš„æ–‡ä»¶');
                        for (const file of selectedFiles) {
                            const targetPath = file.target_path || `/root/${file.filename}`;
                            // ç¡®ä¿ä½¿ç”¨å®Œæ•´çš„URL
                            let fileUrl = file.download_url;
                            if (fileUrl && !fileUrl.startsWith('http://') && !fileUrl.startsWith('https://')) {
                                // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œè½¬æ¢ä¸ºå®Œæ•´URL
                                fileUrl = baseUrl + (fileUrl.startsWith('/') ? fileUrl : '/' + fileUrl);
                            }
                            cmdParts.push(`wget ${fileUrl} -O ${targetPath}`);
                        }
                        cmdParts.push('');
                    }
                    
                    if (buildScriptUrl) {
                        cmdParts.push('# ä¸‹è½½æ„å»ºè„šæœ¬');
                        cmdParts.push(`wget ${buildScriptUrl} -O build.sh`);
                        cmdParts.push('');
                    }
                    
                    cmdParts.push('# ä¸‹è½½ç¯å¢ƒå˜é‡è„šæœ¬');
                    cmdParts.push(`wget ${taskEnvScriptUrl} -O env.sh`);
                    cmdParts.push('');
                    cmdParts.push('# åŠ è½½ç¯å¢ƒå˜é‡');
                    cmdParts.push('source env.sh');
                    cmdParts.push('');
                    cmdParts.push('# ä¸‹è½½è¿è¡Œè„šæœ¬');
                    cmdParts.push(`wget ${runScriptUrl} -O ${runScriptFilename}`);
                    cmdParts.push('');
                    cmdParts.push('# æ‰§è¡Œè¿è¡Œè„šæœ¬');
                    if (runScriptType === 'python') {
                        cmdParts.push(`python3 ${runScriptFilename}`);
                    } else {
                        cmdParts.push(`bash ${runScriptFilename}`);
                    }
                    
                    // æ·»åŠ åˆ°æ‰€æœ‰ä»»åŠ¡é¢„è§ˆä¸­
                    allTasksPreview.push(cmdParts.join('\n'));
                    
                    // å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªä»»åŠ¡ï¼Œæ·»åŠ åˆ†éš”ç¬¦
                    if (i < totalTasks - 1) {
                        allTasksPreview.push('');
                        allTasksPreview.push('# ' + '='.repeat(60));
                        allTasksPreview.push('');
                    }
                }
                
                // ç”Ÿæˆæ ¼å¼åŒ–çš„å‘½ä»¤ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
                const formattedCmd = allTasksPreview.join('\n');
                
                // æ˜¾ç¤ºå¼¹çª—
                document.getElementById('command-preview-text').textContent = formattedCmd;
                
                // æ˜¾ç¤ºä»»åŠ¡æ•°é‡
                const taskCountElement = document.getElementById('preview-task-count');
                if (totalTasks > 1) {
                    taskCountElement.textContent = `å°†åŒæ—¶æäº¤ ${totalTasks} ä¸ªä»»åŠ¡`;
                    taskCountElement.style.display = 'block';
                } else {
                    taskCountElement.textContent = '';
                    taskCountElement.style.display = 'none';
                }
                
                document.getElementById('command-preview-modal').style.display = 'flex';
            } catch (error) {
                console.error('é¢„è§ˆå‘½ä»¤å¤±è´¥:', error);
                alert('é¢„è§ˆå‘½ä»¤å¤±è´¥: ' + error.message);
            }
        }
        
        // å…³é—­é¢„è§ˆå¼¹çª—
        function closeCommandPreview() {
            document.getElementById('command-preview-modal').style.display = 'none';
        }
        
        // åˆ›å»ºéƒ¨ç½²ï¼ˆæ”¯æŒæ‰¹é‡æäº¤ï¼‰
        async function createDeployment() {
            const baseName = document.getElementById('deployment_name').value.trim();
            const deploymentType = document.getElementById('deployment_type').value;
            const imageSelect = document.getElementById('deployment_image');
            const imageOption = imageSelect.options[imageSelect.selectedIndex];
            const imageUuid = imageOption.value;
            
            // è·å–é€‰ä¸­çš„æ•°æ®ä¸­å¿ƒ
            const selectedDCs = Array.from(document.querySelectorAll('.dc-checkbox:checked')).map(cb => cb.value);
            
            // è·å– GPU æ•°é‡å’Œç±»å‹
            const gpuNum = parseInt(document.getElementById('gpu_num').value) || 1;
            const selectedGPUs = Array.from(document.querySelectorAll('.gpu-type-checkbox:checked')).map(cb => cb.value);
            
            // è·å–è¿è¡Œè„šæœ¬
            const runScriptType = document.getElementById('run_script_type').value;
            const runScriptContent = monacoEditor ? monacoEditor.getValue().trim() : '';
            
            // è·å–å†å²è„šæœ¬ï¼ˆbuild.shï¼‰
            const historyScript = document.getElementById('history_script').value;
            
            // è·å–é€‰ä¸­çš„ä¸Šä¼ æ–‡ä»¶
            const selectedFiles = getSelectedFiles();

            // éªŒè¯å¿…å¡«é¡¹
            if (!baseName) {
                alert('è¯·è¾“å…¥éƒ¨ç½²åç§°');
                return;
            }

            if (!imageUuid) {
                alert('è¯·é€‰æ‹©é•œåƒ');
                return;
            }

            if (!selectedGPUs || selectedGPUs.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ª GPU ç±»å‹');
                return;
            }

            if (!runScriptContent) {
                alert('è¯·è¾“å…¥è¿è¡Œè„šæœ¬ä»£ç ');
                return;
            }
            
            // ç”Ÿæˆç¯å¢ƒå˜é‡ç»„åˆ
            const envCombinations = generateEnvVarCombinations();
            const totalTasks = envCombinations.totalCount;
            const envVarMap = envCombinations.envVarMap; // è·å–ç¯å¢ƒå˜é‡æ˜ å°„ï¼Œç”¨äºåˆ¤æ–­å“ªäº›å˜é‡æœ‰å¤šä¸ªå€¼
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ OUTPUT ç¯å¢ƒå˜é‡
            let hasOutput = false;
            envCombinations.combinations.forEach(envVars => {
                if (envVars['OUTPUT']) {
                    hasOutput = true;
                }
            });
            
            if (!hasOutput) {
                alert('å¿…é¡»é…ç½® OUTPUT ç¯å¢ƒå˜é‡');
                return;
            }
            
            // ç¡®è®¤æ‰¹é‡æäº¤
            if (totalTasks > 1) {
                const confirmed = confirm(`å°†åŒæ—¶æäº¤ ${totalTasks} ä¸ªä»»åŠ¡ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ`);
                if (!confirmed) {
                    return;
                }
            }

            try {
                // ç¬¬ä¸€æ­¥ï¼šä¿å­˜runè„šæœ¬å¹¶è·å–ä¸‹è½½URLï¼ˆæ‰€æœ‰ä»»åŠ¡å…±ç”¨ï¼‰
                const runScriptResponse = await fetch('/api/autodl/save-run-script', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        script_content: runScriptContent,
                        script_type: runScriptType
                    })
                });

                const runScriptData = await runScriptResponse.json();
                if (!runScriptResponse.ok) {
                    alert('ä¿å­˜è¿è¡Œè„šæœ¬å¤±è´¥ï¼š' + (runScriptData.error || 'æœªçŸ¥é”™è¯¯'));
                    return;
                }

                const runScriptUrl = runScriptData.download_url;
                const runScriptFilename = runScriptData.filename; // run.sh æˆ– run.py

                // ç¬¬äºŒæ­¥ï¼šå¦‚æœæœ‰å†å²è„šæœ¬ï¼Œè·å–å…¶ä¸‹è½½URLï¼ˆæ‰€æœ‰ä»»åŠ¡å…±ç”¨ï¼‰
                let buildScriptUrl = null;
                if (historyScript) {
                    const buildScriptResponse = await fetch(`/api/scripts/${encodeURIComponent(historyScript)}/download`, {
                        method: 'GET',
                        credentials: 'same-origin'
                    });
                    const buildScriptData = await buildScriptResponse.json();
                    if (buildScriptResponse.ok && buildScriptData.download_url) {
                        buildScriptUrl = buildScriptData.download_url;
                    } else {
                        alert('è·å–å†å²è„šæœ¬ä¸‹è½½é“¾æ¥å¤±è´¥ï¼š' + (buildScriptData.error || 'æœªçŸ¥é”™è¯¯'));
                        return;
                    }
                }
                
                // ç¬¬ä¸‰æ­¥ï¼šæ‰¹é‡åˆ›å»ºéƒ¨ç½²
                let successCount = 0;
                let failCount = 0;
                const errors = [];
                
                for (let i = 0; i < totalTasks; i++) {
                    const envVars = envCombinations.combinations[i];
                    
                    // ç”Ÿæˆéƒ¨ç½²åç§°ï¼ˆå¦‚æœæ˜¯æ‰¹é‡æäº¤ï¼Œæ·»åŠ åç¼€ï¼‰
                    let deploymentName = baseName;
                    if (totalTasks > 1) {
                        // æ ¹æ®ç¯å¢ƒå˜é‡å€¼ç”Ÿæˆåç¼€ï¼ˆåªåŒ…å«æœ‰å¤šä¸ªå€¼çš„ç¯å¢ƒå˜é‡ï¼‰
                        const suffixParts = [];
                        Object.keys(envVars).forEach(key => {
                            if (key !== 'JOB_NAME' && key !== 'GPU_NUM' && key !== 'OUTPUT') {
                                // åªå¤„ç†æœ‰å¤šä¸ªå€¼çš„ç¯å¢ƒå˜é‡
                                if (envVarMap[key] && envVarMap[key].length > 1) {
                                    const value = envVars[key];
                                    // ç®€åŒ–å€¼ä½œä¸ºåç¼€ï¼ˆ/ æ›¿æ¢ä¸º .ï¼Œå…¶ä»–ç‰¹æ®Šå­—ç¬¦æ›¿æ¢ä¸º _ï¼‰
                                    const cleanValue = value.toString().replace(/\//g, '.').replace(/[^a-zA-Z0-9.]/g, '_');
                                    suffixParts.push(`${key}_${cleanValue}`);
                                }
                            }
                        });
                        if (suffixParts.length > 0) {
                            deploymentName = `${baseName}_${suffixParts.join('_')}`;
                        } else {
                            deploymentName = `${baseName}_${i + 1}`;
                        }
                    }
                    
                    try {
                        // ä¿å­˜ç¯å¢ƒå˜é‡è„šæœ¬ï¼ˆenv.shï¼‰å¹¶è·å–ä¸‹è½½URL
                        const envScriptResponse = await fetch('/api/autodl/save-env-script', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            credentials: 'same-origin',
                            body: JSON.stringify({
                                env_vars: envVars
                            })
                        });

                        const envScriptData = await envScriptResponse.json();
                        if (!envScriptResponse.ok) {
                            throw new Error('ä¿å­˜ç¯å¢ƒå˜é‡è„šæœ¬å¤±è´¥ï¼š' + (envScriptData.error || 'æœªçŸ¥é”™è¯¯'));
                        }

                        const envScriptUrl = envScriptData.download_url;
                        
                        // æ„å»ºå¯åŠ¨å‘½ä»¤
                        let cmd = '';
                        
                        // å…ˆä¸‹è½½æ‰€æœ‰é€‰ä¸­çš„æ–‡ä»¶
                        for (const file of selectedFiles) {
                            const targetPath = file.target_path || `/root/${file.filename}`;
                            cmd += `wget ${file.download_url} -O ${targetPath} && `;
                        }
                        
                        if (buildScriptUrl) {
                            cmd += `wget ${buildScriptUrl} -O build.sh && `;
                        }
                        cmd += `wget ${envScriptUrl} -O env.sh && `;
                        cmd += `source env.sh && `;
                        cmd += `wget ${runScriptUrl} -O ${runScriptFilename} && `;
                        if (runScriptType === 'python') {
                            cmd += `python3 ${runScriptFilename}`;
                        } else {
                            cmd += `bash ${runScriptFilename}`;
                        }
                        
                        // åˆ›å»ºéƒ¨ç½²
                        const response = await fetch('/api/autodl/create-deployment', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            credentials: 'same-origin',
                            body: JSON.stringify({
                                name: deploymentName,
                                image_uuid: imageUuid,
                                deployment_type: deploymentType,
                                dc_list: selectedDCs,
                                gpu_num: gpuNum,
                                gpu_name_set: selectedGPUs,
                                cmd: cmd,
                                run_script_type: runScriptType,
                                run_script_content: runScriptContent,
                                history_script: historyScript || null,
                                env_vars: envVars  // ä»…ç”¨äºä¿å­˜é…ç½®
                            })
                        });

                        const data = await response.json();
                        if (response.ok) {
                            successCount++;
                            console.log(`âœ“ ä»»åŠ¡ ${i + 1}/${totalTasks} åˆ›å»ºæˆåŠŸ: ${deploymentName}`);
                        } else {
                            failCount++;
                            const errorMsg = `ä»»åŠ¡ ${i + 1}/${totalTasks} (${deploymentName}): ${data.error || 'æœªçŸ¥é”™è¯¯'}`;
                            errors.push(errorMsg);
                            console.error(`âœ— ${errorMsg}`);
                        }
                    } catch (error) {
                        failCount++;
                        const errorMsg = `ä»»åŠ¡ ${i + 1}/${totalTasks} (${deploymentName}): ${error.message}`;
                        errors.push(errorMsg);
                        console.error(`âœ— ${errorMsg}`);
                    }
                }
                
                // æ˜¾ç¤ºç»“æœ
                if (failCount === 0) {
                    alert(`âœ… æ‰€æœ‰ ${totalTasks} ä¸ªä»»åŠ¡åˆ›å»ºæˆåŠŸï¼`);
                } else {
                    let message = `âš ï¸ å®Œæˆæƒ…å†µï¼šæˆåŠŸ ${successCount} ä¸ªï¼Œå¤±è´¥ ${failCount} ä¸ª\n\n`;
                    if (errors.length > 0) {
                        message += 'å¤±è´¥è¯¦æƒ…ï¼š\n' + errors.slice(0, 5).join('\n');
                        if (errors.length > 5) {
                            message += `\n... è¿˜æœ‰ ${errors.length - 5} ä¸ªé”™è¯¯`;
                        }
                    }
                    alert(message);
                }
                
                // åˆ‡æ¢åˆ°éƒ¨ç½²åˆ—è¡¨å¹¶åˆ·æ–°
                const deploymentsTab = document.querySelector('.nav-tab[data-tab="deployments"]');
                if (deploymentsTab) {
                    switchTab('deployments', deploymentsTab);
                }
            } catch (error) {
                alert('æ‰¹é‡åˆ›å»ºéƒ¨ç½²å¤±è´¥ï¼š' + error.message);
            }
        }

        // åŠ è½½ä»»åŠ¡æäº¤é…ç½®åˆ—è¡¨
        async function loadDeploymentConfigsList() {
            const select = document.getElementById('load_config_select');
            if (!select) return;
            select.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
            
            try {
                const response = await fetch('/api/autodl/deployment-configs', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                // æ£€æŸ¥å“åº”ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    select.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„å“åº”</option>';
                    return;
                }
                
                const data = await response.json();
                if (response.ok) {
                    select.innerHTML = '<option value="">åŠ è½½å†å²é…ç½®...</option>';
                    
                    if (data.configs && data.configs.length > 0) {
                        data.configs.forEach(config => {
                            const option = document.createElement('option');
                            option.value = config.full_filename;
                            
                            // æ˜¾ç¤ºé…ç½®åç§°å’Œåˆ›å»ºæ—¶é—´
                            const configName = config.config.name || 'æœªå‘½åéƒ¨ç½²';
                            const createdDate = new Date(config.modified);
                            const formattedDate = createdDate.toLocaleString('zh-CN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            
                            option.textContent = `${configName} (${formattedDate})`;
                            option.dataset.config = JSON.stringify(config.config); // ä¿å­˜é…ç½®æ•°æ®
                            select.appendChild(option);
                        });
                    }
                } else {
                    select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                    console.error('Failed to load configs:', data.error);
                }
            } catch (error) {
                select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                console.error('Error loading configs:', error);
            }
        }

        // åŠ è½½é€‰ä¸­çš„é…ç½®åˆ°ç•Œé¢
        async function loadSelectedConfig() {
            const select = document.getElementById('load_config_select');
            const selectedOption = select.options[select.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé…ç½®');
                return;
            }
            
            try {
                // ä»optionä¸­è·å–é…ç½®æ•°æ®
                const configData = JSON.parse(selectedOption.dataset.config);
                
                // åŠ è½½é…ç½®åˆ°ç•Œé¢
                loadConfigToForm(configData);
                
                alert('é…ç½®åŠ è½½æˆåŠŸï¼');
            } catch (error) {
                console.error('Error loading config:', error);
                alert('åŠ è½½é…ç½®å¤±è´¥ï¼š' + error.message);
            }
        }

        // å°†é…ç½®æ•°æ®åŠ è½½åˆ°è¡¨å•
        function loadConfigToForm(config) {
            // éƒ¨ç½²åç§°
            if (config.name) {
                document.getElementById('deployment_name').value = config.name;
                // æ›´æ–°åªè¯»ç¯å¢ƒå˜é‡JOB_NAME
                updateReadonlyEnvVar('JOB_NAME', config.name);
            }
            
            // éƒ¨ç½²ç±»å‹
            if (config.deployment_type) {
                document.getElementById('deployment_type').value = config.deployment_type;
            }
            
            // é•œåƒUUIDï¼ˆéœ€è¦å…ˆåŠ è½½é•œåƒåˆ—è¡¨æ‰èƒ½é€‰æ‹©ï¼‰
            if (config.image_uuid) {
                const imageSelect = document.getElementById('deployment_image');
                // å¦‚æœé•œåƒåˆ—è¡¨å·²åŠ è½½ï¼Œå°è¯•é€‰æ‹©å¯¹åº”çš„é•œåƒ
                if (imageSelect.options.length > 1) {
                    for (let i = 0; i < imageSelect.options.length; i++) {
                        if (imageSelect.options[i].value === config.image_uuid) {
                            imageSelect.selectedIndex = i;
                            break;
                        }
                    }
                } else {
                    // å¦‚æœé•œåƒåˆ—è¡¨æœªåŠ è½½ï¼Œå…ˆåŠ è½½é•œåƒåˆ—è¡¨
                    loadImages().then(() => {
                        setTimeout(() => {
                            for (let i = 0; i < imageSelect.options.length; i++) {
                                if (imageSelect.options[i].value === config.image_uuid) {
                                    imageSelect.selectedIndex = i;
                                    break;
                                }
                            }
                        }, 500);
                    });
                }
            }
            
            // æ•°æ®ä¸­å¿ƒåˆ—è¡¨
            if (config.dc_list && Array.isArray(config.dc_list)) {
                document.querySelectorAll('.dc-checkbox').forEach(cb => {
                    cb.checked = config.dc_list.includes(cb.value);
                });
            }
            
            // GPUæ•°é‡
            if (config.gpu_num) {
                document.getElementById('gpu_num').value = config.gpu_num;
                // æ›´æ–°åªè¯»ç¯å¢ƒå˜é‡GPU_NUM
                updateReadonlyEnvVar('GPU_NUM', config.gpu_num.toString());
            }
            
            // GPUç±»å‹
            if (config.gpu_name_set && Array.isArray(config.gpu_name_set) && config.gpu_name_set.length > 0) {
                document.querySelectorAll('.gpu-type-checkbox').forEach(cb => {
                    // é…ç½®ä¸­å¯èƒ½å­˜å‚¨çš„æ˜¯ "RTX 4090"ï¼ˆå¸¦ç©ºæ ¼ï¼‰æˆ– "RTX-4090"ï¼ˆå¸¦è¿å­—ç¬¦ï¼‰
                    // ç•Œé¢ä½¿ç”¨çš„æ˜¯ "RTX-4090" æ ¼å¼
                    cb.checked = config.gpu_name_set.some(gpu => {
                        // è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼è¿›è¡Œæ¯”è¾ƒ
                        const normalizedConfig = gpu.replace(/ /g, '-');
                        const normalizedValue = cb.value;
                        return normalizedConfig === normalizedValue || gpu === cb.value;
                    });
                });
            }
            
            // å†å²è„šæœ¬
            if (config.history_script) {
                // éœ€è¦å…ˆåŠ è½½å†å²è„šæœ¬åˆ—è¡¨
                loadHistoryScripts().then(() => {
                    setTimeout(() => {
                        const historyScriptSelect = document.getElementById('history_script');
                        for (let i = 0; i < historyScriptSelect.options.length; i++) {
                            if (historyScriptSelect.options[i].value === config.history_script) {
                                historyScriptSelect.selectedIndex = i;
                                break;
                            }
                        }
                    }, 500);
                });
            }
            
            // ç¯å¢ƒå˜é‡
            const container = document.getElementById('env-vars-container');
            container.innerHTML = '';
            
            // é¦–å…ˆæ·»åŠ åªè¯»ç¯å¢ƒå˜é‡ï¼ˆJOB_NAMEå’ŒGPU_NUMï¼‰ï¼Œä»å½“å‰è¡¨å•å€¼è·å–
            const deploymentName = document.getElementById('deployment_name').value.trim() || '';
            const gpuNum = document.getElementById('gpu_num').value.trim() || '1';
            addEnvVar('JOB_NAME', deploymentName, false, true);
            addEnvVar('GPU_NUM', gpuNum, false, true);
            
            if (config.env_vars && typeof config.env_vars === 'object') {
                // åŠ è½½é…ç½®ä¸­çš„ç¯å¢ƒå˜é‡ï¼ˆæ’é™¤JOB_NAMEå’ŒGPU_NUMï¼Œå› ä¸ºå®ƒä»¬ä¼šè‡ªåŠ¨åŒæ­¥ï¼‰
                Object.entries(config.env_vars).forEach(([key, value]) => {
                    if (key !== 'JOB_NAME' && key !== 'GPU_NUM') {
                        const isOutput = key === 'OUTPUT';
                        addEnvVar(key, value, isOutput);
                    }
                });
            }
            
            // ç¡®ä¿ OUTPUT ç¯å¢ƒå˜é‡å­˜åœ¨ï¼ˆå¿…å¡«ï¼‰
            const hasOutput = Array.from(container.querySelectorAll('.env-var-item')).some(item => {
                const keyInput = item.querySelector('.env-var-key');
                return keyInput && keyInput.value.trim() === 'OUTPUT';
            });
            if (!hasOutput) {
                addEnvVar('OUTPUT', '/root/autodl-fs', true, false, 0);
            }
            
            // è¿è¡Œè„šæœ¬ç±»å‹å’Œå†…å®¹
            if (config.run_script_type) {
                document.getElementById('run_script_type').value = config.run_script_type;
            }
            
            if (config.run_script_content) {
                if (monacoEditor) {
                    monacoEditor.setValue(config.run_script_content);
                }
            }
            
            // æ›´æ–°è„šæœ¬ç¼–è¾‘å™¨ï¼ˆå¦‚æœåˆ‡æ¢äº†ç±»å‹ï¼‰
            updateRunScriptEditor();
        }

        // è½¬ä¹‰HTMLå‡½æ•°
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        // ä¿å­˜éƒ¨ç½²é…ç½®ï¼ˆä¸åˆ›å»ºéƒ¨ç½²ï¼‰
        window.saveDeploymentConfig = async function() {
            const name = document.getElementById('deployment_name').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥é…ç½®åç§°');
                return;
            }
            openSaveGroupModal();
        }

        // åŠ è½½é…ç½®åˆ—è¡¨ç”¨äºæ˜¾ç¤ºï¼ˆåˆ—è¡¨å½¢å¼ï¼‰
        async function loadDeploymentConfigsListForDisplay() {
            const listContainer = document.getElementById('deployment-configs-list');
            listContainer.innerHTML = '<div class="scripts-list-empty">æ­£åœ¨åŠ è½½...</div>';
            
            try {
                const response = await fetch('/api/autodl/deployment-configs', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                if (response.ok && data.configs && data.configs.length > 0) {
                    listContainer.innerHTML = '';
                    data.configs.forEach(config => {
                        const item = document.createElement('div');
                        item.className = 'script-file-item';
                        
                        const modifiedDate = new Date(config.modified);
                        const formattedDate = modifiedDate.toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        const configName = config.config.name || 'æœªå‘½åé…ç½®';
                        item.innerHTML = `
                            <div class="script-file-info">
                                <div class="script-file-name">${escapeHtml(configName)}</div>
                                <div class="script-file-meta">
                                    <span>ä¿®æ”¹æ—¶é—´: ${formattedDate}</span>
                                </div>
                            </div>
                            <div class="script-file-actions">
                                <button class="btn-link btn-copy-link" onclick="loadDeploymentConfigFromList('${escapeHtml(config.full_filename)}')" title="åŠ è½½é…ç½®">
                                    <span>ğŸ“¥</span>
                                    <span>åŠ è½½</span>
                                </button>
                                <button class="btn-link btn-delete-link" onclick="deleteDeploymentConfig('${escapeHtml(config.full_filename)}', this)" title="åˆ é™¤é…ç½®">
                                    <span>ğŸ—‘ï¸</span>
                                </button>
                            </div>
                        `;
                        item.dataset.config = JSON.stringify(config.config);
                        listContainer.appendChild(item);
                    });
                } else {
                    listContainer.innerHTML = '<div class="scripts-list-empty">æš‚æ— å†å²é…ç½®</div>';
                }
            } catch (error) {
                listContainer.innerHTML = `<div class="scripts-list-empty">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }

        // ä»åˆ—è¡¨åŠ è½½é…ç½®
        async function loadDeploymentConfigFromList(configFilename) {
            try {
                const response = await fetch(`/api/autodl/deployment-configs/${configFilename}`, {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                if (response.ok) {
                    loadConfigToForm(data.config);
                    alert('é…ç½®åŠ è½½æˆåŠŸï¼');
                } else {
                    alert('åŠ è½½å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('åŠ è½½å¤±è´¥ï¼š' + error.message);
            }
        }

        // åˆ é™¤é…ç½®
        async function deleteDeploymentConfig(configFilename, button) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé…ç½®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/autodl/deployment-configs/${encodeURIComponent(configFilename)}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                if (response.ok) {
                    alert('é…ç½®åˆ é™¤æˆåŠŸ');
                    // åˆ·æ–°é…ç½®åˆ—è¡¨å’Œä¸‹æ‹‰æ¡†
                    await loadDeploymentConfigsListForDisplay();
                    await loadDeploymentConfigsList();
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            try {
                const response = await fetch('/logout', {
                    method: 'POST',
                    credentials: 'same-origin'
                });
                if (response.ok) {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // ç¡®ä¿æ‰€æœ‰å…³é”®å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸå¯ç”¨
        window.previewCommand = previewCommand;
        window.createDeployment = createDeployment;
        window.addEnvVar = addEnvVar;
        window.switchTab = switchTab;
        window.loadUploadedFiles = loadUploadedFiles;
        window.closeCommandPreview = closeCommandPreview;
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        initPage().then(async () => {
            // åˆå§‹åŒ–æ•°æ®ä¸­å¿ƒå¤é€‰æ¡†
            initDatacenterCheckboxes();
            
            // åˆå§‹åŒ–ç¯å¢ƒå˜é‡ï¼ˆç¡®ä¿OUTPUTå­˜åœ¨ï¼‰
            initEnvVars();
            
            // ç›‘å¬éƒ¨ç½²åç§°å˜åŒ–ï¼Œè‡ªåŠ¨æ›´æ–°JOB_NAMEç¯å¢ƒå˜é‡
            document.getElementById('deployment_name').addEventListener('input', function() {
                updateReadonlyEnvVar('JOB_NAME', this.value.trim() || '');
            });
            
            // ç›‘å¬GPUæ•°é‡å˜åŒ–ï¼Œè‡ªåŠ¨æ›´æ–°GPU_NUMç¯å¢ƒå˜é‡
            document.getElementById('gpu_num').addEventListener('input', function() {
                updateReadonlyEnvVar('GPU_NUM', this.value.trim() || '1');
            });
            
            // åˆå§‹åŒ–Monaco Editor
            if (typeof require !== 'undefined') {
                require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });
                require(['vs/editor/editor.main'], async () => {
                    await initMonacoEditor();
                    // åŠ è½½é»˜è®¤è¿è¡Œè„šæœ¬ï¼ˆå¼‚æ­¥ï¼‰
                    await loadDefaultRunScript();
                });
            } else {
                // å¦‚æœMonacoæœªåŠ è½½ï¼Œç­‰å¾…åŠ è½½
                await new Promise(resolve => {
                    if (typeof monaco !== 'undefined') {
                        resolve();
                    } else {
                        const checkMonaco = setInterval(() => {
                            if (typeof monaco !== 'undefined') {
                                clearInterval(checkMonaco);
                                resolve();
                            }
                        }, 100);
                    }
                });
                await initMonacoEditor();
                await loadDefaultRunScript();
            }
            
            // ç­‰å¾…åˆå§‹åŒ–å®Œæˆåå†åŠ è½½æ•°æ®
            await new Promise(resolve => setTimeout(resolve, 200));
            
            // å¦‚æœå½“å‰æ˜¯æäº¤æ ‡ç­¾é¡µï¼Œè‡ªåŠ¨åŠ è½½å†å²è„šæœ¬å’Œé•œåƒåˆ—è¡¨
            if (currentTab === 'submit') {
                // è‡ªåŠ¨åŠ è½½å†å²è„šæœ¬åˆ—è¡¨
                loadHistoryScripts();
                
                // è‡ªåŠ¨åŠ è½½å†å²é…ç½®åˆ—è¡¨
                loadDeploymentConfigsList();
                
                // æ£€æŸ¥Tokenå¹¶åŠ è½½é•œåƒåˆ—è¡¨
                try {
                    const response = await fetch('/api/user/autodl-token', {
                        method: 'GET',
                        credentials: 'same-origin'
                    });
                    const data = await response.json();
                    // å¦‚æœæœ‰Tokenï¼Œè‡ªåŠ¨åŠ è½½é•œåƒåˆ—è¡¨å’Œéƒ¨ç½²åˆ—è¡¨
                    if (data.has_token) {
                        await loadImages();
                        await loadDeployments();
                    }
                } catch (error) {
                    console.error('Auto load images error:', error);
                }
            }
            
            // å¦‚æœå½“å‰æ˜¯å†å²é…ç½®æ ‡ç­¾é¡µï¼Œè‡ªåŠ¨åŠ è½½é…ç½®åˆ—è¡¨
            if (currentTab === 'configs') {
                loadConfigs();
            }
        });

        // ==================== å†å²é…ç½®å¼¹çª—åŠŸèƒ½ ====================
        let currentConfigGroup = '';
        let currentMoveConfigPath = '';

        function openConfigModal() {
            console.log('openConfigModal called');
            const modal = document.getElementById('configModal');
            if (!modal) {
                console.error('configModal element not found');
                alert('é…ç½®å¼¹çª—å…ƒç´ æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            modal.classList.add('active');
            loadConfigGroups();
            loadConfigs();
        }
        
        // ç¡®ä¿å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸ
        window.openConfigModal = openConfigModal;

        function closeConfigModal() {
            document.getElementById('configModal').classList.remove('active');
        }

        async function loadConfigGroups() {
            try {
                const response = await fetch('/api/autodl/deployment-configs/groups');
                const data = await response.json();
                
                const groupFilter = document.getElementById('configGroupFilter');
                const saveGroupSelect = document.getElementById('saveGroupSelect');
                const moveGroupSelect = document.getElementById('moveGroupSelect');
                
                // æ›´æ–°åˆ†ç»„è¿‡æ»¤å™¨
                groupFilter.innerHTML = '<option value="">å…¨éƒ¨åˆ†ç»„</option>';
                data.groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    groupFilter.appendChild(option);
                });
                
                // æ›´æ–°ä¿å­˜åˆ†ç»„é€‰æ‹©å™¨
                saveGroupSelect.innerHTML = '<option value="">é»˜è®¤ï¼ˆä¸åˆ†ç»„ï¼‰</option>';
                data.groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    saveGroupSelect.appendChild(option);
                });
                
                // æ›´æ–°ç§»åŠ¨åˆ†ç»„é€‰æ‹©å™¨
                moveGroupSelect.innerHTML = '<option value="">é»˜è®¤ï¼ˆä¸åˆ†ç»„ï¼‰</option>';
                data.groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    moveGroupSelect.appendChild(option);
                });
            } catch (error) {
                console.error('åŠ è½½åˆ†ç»„åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        async function loadConfigs() {
            try {
                // è·å–æ‰€æœ‰é…ç½®ï¼ˆä¸åˆ†é¡µï¼Œç”¨äºæ ‘å½¢ç»“æ„ï¼‰
                const response = await fetch('/api/autodl/deployment-configs?page=1&per_page=1000');
                
                // æ£€æŸ¥å“åº”ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    throw new Error('æœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„å“åº”ï¼Œå¯èƒ½æ˜¯è·¯ç”±é”™è¯¯');
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const configList = document.getElementById('configList');
                
                // æŒ‰åˆ†ç»„ç»„ç»‡é…ç½®
                const groupedConfigs = {};
                const ungroupedConfigs = [];
                
                data.configs.forEach(config => {
                    const group = config.group || '';
                    if (group) {
                        if (!groupedConfigs[group]) {
                            groupedConfigs[group] = [];
                        }
                        groupedConfigs[group].push(config);
                    } else {
                        ungroupedConfigs.push(config);
                    }
                });
                
                // æ„å»ºæ ‘å½¢ç»“æ„HTML
                let html = '';
                
                // æ˜¾ç¤ºåˆ†ç»„é…ç½®
                Object.keys(groupedConfigs).sort().forEach(group => {
                    html += `
                        <div class="config-group-item" style="margin-bottom: 15px;">
                            <div class="config-group-header" style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #e9ecef; border-radius: 6px; cursor: pointer; margin-bottom: 8px;" onclick="toggleConfigGroup('${group}')">
                                <span class="group-toggle" style="font-size: 0.9em;">â–¶</span>
                                <span style="font-weight: 600; color: #495057;">ğŸ“ ${group}</span>
                                <span style="font-size: 0.85em; color: #6c757d; margin-left: auto;">${groupedConfigs[group].length} ä¸ªé…ç½®</span>
                            </div>
                            <div class="config-group-content" id="group-${group.replace(/[^a-zA-Z0-9]/g, '_')}" style="display: none; padding-left: 20px;">
                                ${groupedConfigs[group].map(config => renderConfigItem(config)).join('')}
                            </div>
                        </div>
                    `;
                });
                
                // æ˜¾ç¤ºæœªåˆ†ç»„é…ç½®
                if (ungroupedConfigs.length > 0) {
                    html += `
                        <div class="config-group-item" style="margin-bottom: 15px;">
                            <div class="config-group-header" style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #e9ecef; border-radius: 6px; cursor: pointer; margin-bottom: 8px;" onclick="toggleConfigGroup('_ungrouped')">
                                <span class="group-toggle" style="font-size: 0.9em;">â–¶</span>
                                <span style="font-weight: 600; color: #495057;">ğŸ“„ æœªåˆ†ç»„</span>
                                <span style="font-size: 0.85em; color: #6c757d; margin-left: auto;">${ungroupedConfigs.length} ä¸ªé…ç½®</span>
                            </div>
                            <div class="config-group-content" id="group__ungrouped" style="display: none; padding-left: 20px;">
                                ${ungroupedConfigs.map(config => renderConfigItem(config)).join('')}
                            </div>
                        </div>
                    `;
                }
                
                if (html === '') {
                    configList.innerHTML = '<div class="scripts-list-empty">æš‚æ— é…ç½®</div>';
                } else {
                    configList.innerHTML = html;
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('configList').innerHTML = '<div class="scripts-list-empty">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }
        
        function renderConfigItem(config) {
            const configData = config.config;
            const modifiedDate = new Date(config.modified).toLocaleString('zh-CN');
            
            return `
                <div class="config-item" style="margin-bottom: 8px;">
                    <div class="config-info">
                        <div class="config-name">${configData.name || 'æœªå‘½åé…ç½®'}</div>
                        <div class="config-meta">
                            <span>ä¿®æ”¹æ—¶é—´: ${modifiedDate}</span>
                            <span>GPU: ${configData.gpu_num || 1} Ã— ${(configData.gpu_name_set || []).join(', ') || 'è‡ªåŠ¨'}</span>
                            <span>é•œåƒ: ${configData.image_uuid ? configData.image_uuid.substring(0, 20) + '...' : 'æœªè®¾ç½®'}</span>
                        </div>
                    </div>
                    <div class="config-actions">
                        <button class="btn-load" onclick="loadConfigFromModal('${config.relative_path}')">åŠ è½½</button>
                        <button class="btn-move" onclick="openMoveGroupModal('${config.relative_path}')">ç§»åŠ¨åˆ°åˆ†ç»„</button>
                        <button class="btn-delete" onclick="deleteConfigFromModal('${config.relative_path}', this)">åˆ é™¤</button>
                    </div>
                </div>
            `;
        }
        
        function toggleConfigGroup(group) {
            console.log('toggleConfigGroup called with group:', group);
            // å¤„ç†æœªåˆ†ç»„çš„æƒ…å†µ
            let groupId;
            if (group === '_ungrouped') {
                groupId = 'group__ungrouped';  // ä¸¤ä¸ªä¸‹åˆ’çº¿
            } else {
                groupId = 'group-' + group.replace(/[^a-zA-Z0-9]/g, '_');
            }
            
            console.log('Looking for element with id:', groupId);
            const content = document.getElementById(groupId);
            if (!content) {
                console.error('Group content not found:', groupId);
                // å°è¯•æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„ID
                const allGroups = document.querySelectorAll('[id^="group-"]');
                console.log('Available group IDs:', Array.from(allGroups).map(el => el.id));
                return;
            }
            
            const header = content.previousElementSibling;
            if (!header) {
                console.error('Group header not found');
                return;
            }
            
            const toggle = header.querySelector('.group-toggle');
            if (!toggle) {
                console.error('Group toggle not found');
                return;
            }
            
            const isHidden = content.style.display === 'none' || !content.style.display || getComputedStyle(content).display === 'none';
            
            if (isHidden) {
                content.style.display = 'block';
                toggle.textContent = 'â–¼';
            } else {
                content.style.display = 'none';
                toggle.textContent = 'â–¶';
            }
        }
        
        // ç¡®ä¿å‡½æ•°åœ¨å…¨å±€ä½œç”¨åŸŸ
        window.toggleConfigGroup = toggleConfigGroup;


        async function loadConfigFromModal(relativePath) {
            try {
                const response = await fetch(`/api/autodl/deployment-configs/${encodeURIComponent(relativePath)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                loadConfigToForm(data.config);
                closeConfigModal();
                alert('é…ç½®å·²åŠ è½½åˆ°é¡µé¢');
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                alert('åŠ è½½é…ç½®å¤±è´¥: ' + error.message);
            }
        }

        async function deleteConfigFromModal(relativePath, button) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé…ç½®å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/autodl/deployment-configs/${encodeURIComponent(relativePath)}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                button.closest('.config-item').remove();
                loadConfigs(); // é‡æ–°åŠ è½½ä»¥æ›´æ–°åˆ†é¡µ
            } catch (error) {
                console.error('åˆ é™¤é…ç½®å¤±è´¥:', error);
                alert('åˆ é™¤é…ç½®å¤±è´¥: ' + error.message);
            }
        }

        function openMoveGroupModal(relativePath) {
            currentMoveConfigPath = relativePath;
            loadConfigGroups();
            document.getElementById('moveGroupModal').classList.add('active');
        }

        function closeMoveGroupModal() {
            document.getElementById('moveGroupModal').classList.remove('active');
            currentMoveConfigPath = '';
        }

        async function confirmMoveConfig() {
            const groupSelect = document.getElementById('moveGroupSelect');
            const newGroupName = document.getElementById('moveNewGroupName').value.trim();
            
            const targetGroup = newGroupName || groupSelect.value || null;
            
            try {
                const response = await fetch('/api/autodl/deployment-configs/move', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        relative_path: currentMoveConfigPath,
                        group: targetGroup
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                closeMoveGroupModal();
                loadConfigs();
                alert('é…ç½®å·²ç§»åŠ¨åˆ°åˆ†ç»„');
            } catch (error) {
                console.error('ç§»åŠ¨é…ç½®å¤±è´¥:', error);
                alert('ç§»åŠ¨é…ç½®å¤±è´¥: ' + error.message);
            }
        }

        // ==================== ä¿å­˜è®¾ç½®åˆ†ç»„é€‰æ‹© ====================
        function openSaveGroupModal() {
            loadConfigGroups();
            document.getElementById('saveGroupModal').classList.add('active');
        }

        function closeSaveGroupModal() {
            document.getElementById('saveGroupModal').classList.remove('active');
            document.getElementById('newGroupName').value = '';
            currentSaveRecordFilename = null; // é‡ç½®
        }

        async function confirmSaveConfig() {
            const groupSelect = document.getElementById('saveGroupSelect');
            const newGroupName = document.getElementById('newGroupName').value.trim();
            
            const targetGroup = newGroupName || groupSelect.value || null;
            
            // å¦‚æœæ˜¯ä¿å­˜æäº¤è®°å½•åˆ°å†å²é…ç½®
            if (currentSaveRecordFilename) {
                try {
                    const response = await fetch(`/api/autodl/deployment-records/${encodeURIComponent(currentSaveRecordFilename)}/save-to-config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            group: targetGroup
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    closeSaveGroupModal();
                    currentSaveRecordFilename = null;
                    alert('è®°å½•å·²ä¿å­˜åˆ°å†å²é…ç½®' + (targetGroup ? `ï¼ˆåˆ†ç»„: ${targetGroup}ï¼‰` : ''));
                    loadConfigs(); // åˆ·æ–°å†å²é…ç½®åˆ—è¡¨
                } catch (error) {
                    console.error('ä¿å­˜è®°å½•åˆ°å†å²é…ç½®å¤±è´¥:', error);
                    alert('ä¿å­˜å¤±è´¥: ' + error.message);
                }
            } else {
                // åŸæ¥çš„ä¿å­˜è®¾ç½®é€»è¾‘
                await saveDeploymentConfigWithGroup(targetGroup);
                closeSaveGroupModal();
            }
        }

        async function saveDeploymentConfigWithGroup(group) {
            try {
                // æ”¶é›†æ‰€æœ‰é…ç½®ä¿¡æ¯ï¼ˆä¸åŸæ¥çš„saveDeploymentConfigç›¸åŒï¼‰
                const deploymentName = document.getElementById('deployment_name').value.trim() || 'æœªå‘½åé…ç½®';
                const deploymentType = document.getElementById('deployment_type').value;
                const imageUuid = document.getElementById('deployment_image').value;
                const gpuNum = parseInt(document.getElementById('gpu_num').value) || 1;
                const selectedGPUs = Array.from(document.querySelectorAll('.gpu-type-checkbox:checked')).map(cb => cb.value);
                const selectedDCs = Array.from(document.querySelectorAll('.dc-checkbox:checked')).map(cb => cb.value);
                const runScriptType = document.getElementById('run_script_type').value;
                const runScriptContent = monacoEditor ? monacoEditor.getValue() : '';
                const historyScript = document.getElementById('history_script').value;
                
                // è·å–ç¯å¢ƒå˜é‡
                const envVars = {};
                const deploymentNameVal = document.getElementById('deployment_name').value.trim() || '';
                const gpuNumStr = document.getElementById('gpu_num').value.trim() || '1';
                envVars['JOB_NAME'] = deploymentNameVal;
                envVars['GPU_NUM'] = gpuNumStr;
                
                document.querySelectorAll('.env-var-row').forEach(row => {
                    const keyInput = row.querySelector('.env-var-key');
                    const valueInput = row.querySelector('.env-var-value');
                    if (keyInput && valueInput) {
                        const key = keyInput.value.trim();
                        const value = valueInput.value.trim();
                        if (key) {
                            envVars[key] = value;
                        }
                    }
                });
                
                const configData = {
                    name: deploymentName,
                    deployment_type: deploymentType,
                    image_uuid: imageUuid,
                    dc_list: selectedDCs,
                    gpu_num: gpuNum,
                    gpu_name_set: selectedGPUs,
                    env_vars: envVars,
                    replica_num: 1,
                    parallelism_num: null,
                    cmd: '',
                    run_script_type: runScriptType,
                    run_script_content: runScriptContent,
                    history_script: historyScript || null,
                    group: group
                };
                
                const response = await fetch('/api/autodl/deployment-configs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });
                
                // æ£€æŸ¥å“åº”ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    throw new Error('æœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„å“åº”');
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                alert('é…ç½®ä¿å­˜æˆåŠŸ' + (group ? `ï¼ˆåˆ†ç»„: ${group}ï¼‰` : ''));
                if (document.getElementById('configModal').classList.contains('active')) {
                    loadConfigs();
                }
            } catch (error) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                alert('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message);
            }
        }

        // ==================== ä»»åŠ¡è®°å½•åŠŸèƒ½ ====================
        let currentRecordsPage = 1;
        const recordsPerPage = 10;
        let currentSaveRecordFilename = null;

        async function loadRecords() {
            try {
                const response = await fetch(`/api/autodl/deployment-records?page=${currentRecordsPage}&per_page=${recordsPerPage}`);
                
                // æ£€æŸ¥å“åº”ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text.substring(0, 200));
                    const recordsList = document.getElementById('records-list');
                    if (recordsList) {
                        recordsList.innerHTML = '<div class="scripts-list-empty">åŠ è½½å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„å“åº”</div>';
                    }
                    return;
                }
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const recordsList = document.getElementById('records-list');
                const pagination = data.pagination;
                
                if (data.records.length === 0) {
                    recordsList.innerHTML = '<div class="scripts-list-empty">æš‚æ— ä»»åŠ¡è®°å½•</div>';
                } else {
                    recordsList.innerHTML = data.records.map(record => {
                        const recordData = record.record;
                        const modifiedDate = new Date(record.modified).toLocaleString('zh-CN');
                        const deploymentUuid = recordData.deployment_uuid || 'æœªçŸ¥';
                        
                        return `
                            <div class="config-item" style="margin-bottom: 10px;">
                                <div class="config-info">
                                    <div class="config-name">${recordData.name || 'æœªå‘½åéƒ¨ç½²'} <span style="color: #28a745; font-size: 0.85em;">[è®°å½•]</span></div>
                                    <div class="config-meta">
                                        <span>æäº¤æ—¶é—´: ${modifiedDate}</span>
                                        <span>éƒ¨ç½²UUID: ${deploymentUuid.substring(0, 20)}${deploymentUuid.length > 20 ? '...' : ''}</span>
                                        <span>GPU: ${recordData.gpu_num || 1} Ã— ${(recordData.gpu_name_set || []).join(', ') || 'è‡ªåŠ¨'}</span>
                                        <span>é•œåƒ: ${recordData.image_uuid ? recordData.image_uuid.substring(0, 20) + '...' : 'æœªè®¾ç½®'}</span>
                                    </div>
                                </div>
                                <div class="config-actions">
                                    <button class="btn-load" onclick="loadRecordToForm('${record.full_filename}')">åŠ è½½</button>
                                    <button class="btn-move" onclick="saveRecordToConfig('${record.full_filename}')" style="background: #17a2b8;">ä¿å­˜åˆ°å†å²é…ç½®</button>
                                    <button class="btn-delete" onclick="deleteRecord('${record.full_filename}', this)">åˆ é™¤</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // æ›´æ–°åˆ†é¡µä¿¡æ¯
                updateRecordsPagination(pagination);
            } catch (error) {
                console.error('åŠ è½½æäº¤è®°å½•å¤±è´¥:', error);
                document.getElementById('records-list').innerHTML = '<div class="scripts-list-empty">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }

        function updateRecordsPagination(pagination) {
            document.getElementById('recordsPaginationInfo').textContent = `ç¬¬ ${pagination.page} é¡µï¼Œå…± ${pagination.pages} é¡µï¼Œå…± ${pagination.total} æ¡`;
            document.getElementById('recordsPageInfo').textContent = `${pagination.page} / ${pagination.pages}`;
            document.getElementById('recordsPrevPageBtn').disabled = pagination.page <= 1;
            document.getElementById('recordsNextPageBtn').disabled = pagination.page >= pagination.pages;
        }

        function changeRecordsPage(delta) {
            const newPage = currentRecordsPage + delta;
            if (newPage >= 1) {
                currentRecordsPage = newPage;
                loadRecords();
            }
        }

        async function loadRecordToForm(recordFilename) {
            try {
                const response = await fetch(`/api/autodl/deployment-records/${encodeURIComponent(recordFilename)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                loadConfigToForm(data.record);
                // åˆ‡æ¢åˆ°åˆ›å»ºä»»åŠ¡æ ‡ç­¾é¡µ
                const submitTab = document.querySelector('.nav-tab[data-tab="submit"]');
                if (submitTab) {
                    switchTab('submit', submitTab);
                }
                alert('è®°å½•å·²åŠ è½½åˆ°é¡µé¢');
            } catch (error) {
                console.error('åŠ è½½è®°å½•å¤±è´¥:', error);
                alert('åŠ è½½è®°å½•å¤±è´¥: ' + error.message);
            }
        }

        async function saveRecordToConfig(recordFilename) {
            // æ‰“å¼€ä¿å­˜åˆ°å†å²é…ç½®çš„å¼¹çª—
            currentSaveRecordFilename = recordFilename;
            loadConfigGroups();
            document.getElementById('saveGroupModal').classList.add('active');
        }

        async function deleteRecord(recordFilename, button) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡è®°å½•å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/autodl/deployment-records/${encodeURIComponent(recordFilename)}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                button.closest('.config-item').remove();
                loadRecords(); // é‡æ–°åŠ è½½ä»¥æ›´æ–°åˆ†é¡µ
            } catch (error) {
                console.error('åˆ é™¤è®°å½•å¤±è´¥:', error);
                alert('åˆ é™¤è®°å½•å¤±è´¥: ' + error.message);
            }
        }

        // ä¿®æ”¹confirmSaveConfigå‡½æ•°ï¼Œæ”¯æŒä¿å­˜æäº¤è®°å½•åˆ°å†å²é…ç½®
        const originalConfirmSaveConfig = confirmSaveConfig;
        window.confirmSaveConfig = async function() {
            const groupSelect = document.getElementById('saveGroupSelect');
            const newGroupName = document.getElementById('newGroupName').value.trim();
            
            const targetGroup = newGroupName || groupSelect.value || null;
            
            // å¦‚æœæ˜¯ä¿å­˜æäº¤è®°å½•åˆ°å†å²é…ç½®
            if (currentSaveRecordFilename) {
                try {
                    const response = await fetch(`/api/autodl/deployment-records/${encodeURIComponent(currentSaveRecordFilename)}/save-to-config`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            group: targetGroup
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    closeSaveGroupModal();
                    currentSaveRecordFilename = null;
                    alert('è®°å½•å·²ä¿å­˜åˆ°å†å²é…ç½®' + (targetGroup ? `ï¼ˆåˆ†ç»„: ${targetGroup}ï¼‰` : ''));
                    loadConfigs(); // åˆ·æ–°å†å²é…ç½®åˆ—è¡¨
                } catch (error) {
                    console.error('ä¿å­˜è®°å½•åˆ°å†å²é…ç½®å¤±è´¥:', error);
                    alert('ä¿å­˜å¤±è´¥: ' + error.message);
                }
            } else {
                // åŸæ¥çš„ä¿å­˜è®¾ç½®é€»è¾‘
                await originalConfirmSaveConfig();
            }
        };

    </script>
</body>
</html>

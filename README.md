# 作业脚本生成器 Web 工具

## 功能说明

这是一个基于 Flask 的 Web 工具，用于自动生成作业执行脚本。

### 主要功能

1. **选择代码仓库**：可选择需要克隆和安装的代码仓库
   - hq_det（可选择是否安装依赖）
   - hq_job（可选择是否安装）
   - Image-Comparison-Tool（可选择是否安装）
   - **每个仓库都支持独立选择是否安装**

2. **选择数据快照**：可添加多个数据快照ID和对应的名称

3. **模型下载**：可选择需要下载的模型文件
   - 支持从百度网盘下载（配置 `remote_path`）
   - 支持从 URL 直接下载（配置 `url`，如 GitHub Releases）

4. **数据集生成**：
   - 按目录生成：将所有快照的 `train` 目录合并为训练集，`valid` 目录合并为验证集
   - 随机划分：将所有图片随机划分为训练集和验证集（可设置比例）

## 使用方法

### 安装依赖

```bash
pip install flask
```

### 运行工具

```bash
python app.py
```

然后在浏览器中访问：`http://localhost:5000`

### 使用步骤

1. **选择代码仓库**：在界面上勾选需要克隆的仓库
2. **添加数据快照**：
   - 设置快照数量
   - 为每个快照输入ID和名称（名称可选）
3. **配置数据集生成**：
   - 设置输出目录（默认：`/root/autodl-tmp`）
   - 设置数据集名称（默认：`merged_dataset`）
   - 选择生成方式：
     - 按目录生成：自动合并所有快照的 train/valid 目录
     - 随机划分：随机划分所有图片（可设置训练集比例）
4. **生成脚本**：点击"生成执行脚本"按钮，查看生成的脚本
5. **下载脚本**：点击"下载脚本"按钮保存为 `auto_job.sh`

## 生成的脚本功能

生成的脚本会自动执行以下操作：

1. 设置环境配置（百度网盘访问令牌等）
2. 安装 bdnd 工具
3. 下载 SSH 配置
4. 克隆选定的代码仓库
5. 安装需要安装的仓库依赖
6. 下载所有选定的数据快照（优先从 `/root/autodl-fs` 复制，不存在则下载）
7. 下载所有选定的模型文件（优先从 `/root/autodl-fs` 复制，不存在则下载，支持 URL 下载和百度网盘下载）
8. 生成数据集（按目录或随机划分）
9. 合并 COCO 格式的标注文件

## 缓存机制

生成的脚本支持智能缓存机制，可以避免重复下载并自动建立缓存：

### 缓存选项说明

每个快照和模型都有一个"启用缓存"选项：
- **启用缓存**：既会从 autodl-fs 读取已有缓存，也会在下载后保存新缓存
- **禁用缓存**：仍会从 autodl-fs 读取已有缓存（如果存在），但下载后不会保存新缓存

**注意**：禁用缓存只是不保存新缓存，而不是不使用已有缓存。这样可以节省存储空间，同时仍然可以利用已有的缓存文件。

### 快照缓存
- **读取缓存**：无论是否启用缓存，脚本都会先检查 `/root/autodl-fs/{快照名称}` 目录是否存在
  - 如果存在，直接复制到 `/root/autodl-tmp/{快照名称}`，跳过下载
  - 如果不存在，才执行下载操作
- **保存缓存**：只有启用缓存时，下载完成后才会复制一份到 `/root/autodl-fs/{快照名称}` 作为缓存

### 模型缓存
- **读取缓存**：无论是否启用缓存，脚本都会先检查 `/root/autodl-fs/model/{模型名称}` 目录是否存在
  - 对于 URL 下载：优先检查是否存在对应的模型文件
  - 对于百度网盘下载：检查整个模型目录
  - 如果存在，直接复制到目标路径，跳过下载
  - 如果不存在，才执行下载操作
- **保存缓存**：只有启用缓存时，下载完成后才会复制一份到 `/root/autodl-fs/model/{模型名称}` 作为缓存

这样可以显著提高脚本执行速度，特别是在重复运行相同配置时。首次下载后如果启用了缓存会自动建立缓存，后续运行可以直接使用缓存，无需重复下载。

## 多账户系统

工具支持多账户登录，每个账户的数据是隔离的：

### 账户配置

在配置文件中配置多个账户：

```json
{
    "accounts": {
        "admin": "admin_password",
        "user1": "user1_password",
        "user2": "user2_password"
    }
}
```

### 权限说明

- **admin 账户**：拥有最高权限
  - 可以查看所有用户保存的脚本和配置
  - 可以访问所有用户的数据
  - 脚本和配置保存在根目录

- **普通账户**：数据隔离
  - 只能查看和操作自己保存的脚本和配置
  - 脚本和配置保存在各自的用户目录下
  - 无法访问其他用户的数据

### 数据存储结构

```
/root/autodl_scripts_storage/     # 脚本存储根目录
├── script1.sh                     # admin 的脚本（旧数据，向后兼容）
├── admin/                         # admin 的脚本目录
│   └── script2.sh
├── user1/                         # user1 的脚本目录
│   └── script3.sh
└── user2/                         # user2 的脚本目录
    └── script4.sh

/root/autodl_configs_storage/      # 配置存储根目录
├── config1.json                   # admin 的配置（旧数据，向后兼容）
├── admin/                         # admin 的配置目录
│   └── config2.json
├── user1/                         # user1 的配置目录
│   └── config3.json
└── user2/                         # user2 的配置目录
    └── config4.json
```

## 注意事项

- 确保已配置 `.config` 文件（包含 API 凭证）
- 确保已安装 `moli_dataset_export.py` 脚本
- 生成的脚本需要在 Linux 环境下运行
- 随机划分使用固定随机种子（42）确保可复现
- 如果 `/root/autodl-fs` 目录中有缓存文件，脚本会优先使用缓存，避免重复下载
- **多账户配置**：在配置文件中使用 `accounts` 字段配置多个账户，`login` 字段用于向后兼容

## 模型配置说明

模型配置支持两种下载方式：

### 1. 从百度网盘下载（原有方式）

```json
{
    "models": {
        "dino": {
            "remote_path": "/apps/autodl/model/dino/",
            "local_path": "/root/autodl-tmp/model/dino"
        }
    }
}
```

### 2. 从 URL 直接下载（新增）

```json
{
    "models": {
        "rtdetrv2": {
            "url": "https://github.com/lyuwenyu/storage/releases/download/v0.1/rtdetrv2_r34vd_120e_coco_ema.pth",
            "local_path": "/root/autodl-tmp/model/rtdetrv2",
            "filename": "rtdetrv2_r34vd_120e_coco_ema.pth"
        }
    }
}
```

**配置字段说明：**
- `url`（必需）：模型文件的下载 URL
- `local_path`（必需）：本地保存路径
- `filename`（可选）：保存的文件名，如果不指定则从 URL 中自动提取

**优先级：** 如果同时配置了 `url` 和 `remote_path`，优先使用 `url` 下载。

